<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>Solicitud Almuerzo</title>
  <script src="https://cdn.tailwindcss.com"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/3.3.4/vue.global.prod.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
  /* Personalizaci칩n extra sobre Tailwind */
  body {
    -webkit-tap-highlight-color: transparent;
    font-family: 'Inter', sans-serif;
  }

  /* Scrollbar oculta para pesta침as horizontales */
  .no-scrollbar::-webkit-scrollbar {
    display: none;
  }
  .no-scrollbar {
    -ms-overflow-style: none;
    scrollbar-width: none;
  }

  /* Ajuste para iOS en el footer */
  .safe-area-pb {
    padding-bottom: env(safe-area-inset-bottom, 1rem);
  }

  /* Animaciones suaves */
  .fade-enter-active, .fade-leave-active {
    transition: opacity 0.3s ease;
  }
  .fade-enter-from, .fade-leave-to {
    opacity: 0;
  }

  @keyframes fadeInUp {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .animate-fade-in-up {
    animation: fadeInUp 0.5s ease-out forwards;
  }

  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }
  .animate-fade-in {
    animation: fadeIn 0.5s ease-out forwards;
  }

  @keyframes wave {
    0% { transform: rotate(0deg); }
    20% { transform: rotate(15deg); }
    40% { transform: rotate(-10deg); }
    60% { transform: rotate(5deg); }
    100% { transform: rotate(0deg); }
  }
  .animate-wave {
    display: inline-block;
    animation: wave 2s infinite;
    transform-origin: 70% 70%;
  }

  @keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-5px); }
    75% { transform: translateX(5px); }
  }
  .animate-shake {
    animation: shake 0.4s ease-in-out;
  }

  @keyframes bounceSlow {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-10px); }
  }
  .animate-bounce-slow {
    animation: bounceSlow 3s infinite ease-in-out;
  }
</style>
</head>
<body class="bg-gray-50 text-gray-800 antialiased selection:bg-blue-100 selection:text-blue-800">
  <div id="app" class="min-h-screen flex flex-col">

    <!-- Top Tier Header -->
    <header class="bg-white/80 backdrop-blur-md sticky top-0 z-50 border-b border-gray-200/50 supports-[backdrop-filter]:bg-white/60">
      <div class="max-w-4xl mx-auto px-4 h-16 flex items-center justify-between">
        <!-- Brand / Logo -->
        <div class="flex items-center gap-3 group cursor-default">
           <div class="w-10 h-10 bg-gradient-to-br from-blue-600 to-indigo-600 rounded-xl flex items-center justify-center text-white text-lg shadow-lg shadow-blue-500/30 transition-transform group-hover:scale-105">
             <i class="fa-solid fa-utensils"></i>
           </div>
           <div class="flex flex-col">
             <span class="font-bold text-gray-900 leading-none tracking-tight">Almuerzo</span>
             <span class="text-[10px] text-gray-500 font-semibold uppercase tracking-wider mt-0.5">Corporativo</span>
           </div>
        </div>

        <!-- User Actions -->
        <div class="flex items-center gap-3 md:gap-4">

           <!-- Proxy User Selector (Only for ADMIN_DEP) -->
           <div v-if="isDeptAdmin && deptUsers.length > 0" class="mr-1">
              <div class="relative">
                 <select v-model="impersonateEmail" @change="changeProxyUser"
                   class="appearance-none bg-indigo-50 border border-indigo-100 text-indigo-700 text-xs font-bold py-2 pl-3 pr-8 rounded-lg cursor-pointer hover:bg-indigo-100 transition-colors focus:outline-none focus:ring-2 focus:ring-indigo-500 max-w-[120px] md:max-w-xs truncate">
                   <option value="">Yo</option>
                   <option v-for="u in deptUsers" :key="u.email" :value="u.email">
                      {{ u.nombre }}
                   </option>
                 </select>
                 <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-indigo-500">
                    <i class="fa-solid fa-chevron-down text-[10px]"></i>
                 </div>
              </div>
           </div>

           <!-- Admin Panel Button -->
           <button v-if="isAdmin" @click="toggleAdminView"
             :class="['w-9 h-9 rounded-full flex items-center justify-center transition-all shadow-md',
               viewMode === 'ADMIN' ? 'bg-blue-600 text-white ring-2 ring-offset-2 ring-blue-500' : 'bg-gray-900 text-white hover:bg-gray-700']"
             :title="viewMode === 'ADMIN' ? 'Volver a Pedidos' : 'Panel de Administraci칩n'">
             <i :class="viewMode === 'ADMIN' ? 'fa-solid fa-arrow-left' : 'fa-solid fa-screwdriver-wrench text-xs'"></i>
           </button>

           <button @click="toggleReminders"
             :class="['w-9 h-9 rounded-full flex items-center justify-center transition-all focus:outline-none',
               remindersEnabled ? 'bg-blue-50 text-blue-600 hover:bg-blue-100' : 'bg-gray-100 text-gray-400 hover:bg-gray-200']"
             :title="remindersEnabled ? 'Notificaciones activas' : 'Notificaciones desactivadas'">
             <i :class="['fa-solid text-sm', remindersEnabled ? 'fa-bell' : 'fa-bell-slash']"></i>
           </button>

           <div class="flex items-center gap-3 pl-4 border-l border-gray-200">
              <div class="text-right hidden sm:block leading-tight">
                <div class="text-sm font-bold text-gray-900 truncate max-w-[120px]">{{ user.nombre }}</div>
                <div class="text-[10px] text-gray-500 font-medium uppercase tracking-wide">{{ user.departamento }}</div>
              </div>
              <div class="w-9 h-9 bg-gradient-to-br from-gray-100 to-gray-200 text-gray-600 rounded-full flex items-center justify-center font-bold text-sm border-2 border-white shadow-sm ring-1 ring-gray-100">
                 {{ user.nombre ? user.nombre.charAt(0).toUpperCase() : 'U' }}
              </div>
           </div>
        </div>
      </div>
    </header>

    <!-- Loading Overlay -->
    <div v-if="loading" class="fixed inset-0 bg-white/90 backdrop-blur-sm z-[60] flex flex-col items-center justify-center transition-all duration-300">
      <div class="relative">
         <div class="w-16 h-16 border-4 border-blue-100 rounded-full animate-spin border-t-blue-600"></div>
         <i class="fa-solid fa-utensils absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-blue-600 text-xl"></i>
      </div>
      <p class="mt-4 text-sm text-gray-500 font-medium animate-pulse">Preparando men칰...</p>
    </div>

    <main :class="['flex-grow mx-auto w-full p-4 md:p-6 transition-all duration-300', viewMode === 'ADMIN' ? 'max-w-7xl' : 'max-w-4xl space-y-8']">

      <!-- USER VIEW -->
      <div v-show="viewMode === 'USER'" class="space-y-8">

      <!-- Hero Section -->
      <div class="flex justify-between items-end animate-fade-in-up">
        <div>
          <h1 class="text-2xl sm:text-3xl font-bold text-gray-900 tracking-tight">
             Hola, {{ user.nombre ? user.nombre.split(' ')[0] : 'Colaborador' }} <span class="inline-block animate-wave">游녦</span>
          </h1>
          <p class="text-gray-500 font-medium mt-1">Elige tus favoritos para esta semana.</p>
        </div>
      </div>

      <!-- Banner -->
      <div v-if="showMultiDayBanner" class="bg-gradient-to-r from-indigo-600 to-blue-600 rounded-2xl p-5 shadow-lg shadow-blue-500/20 text-white relative overflow-hidden group animate-fade-in">
         <div class="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full blur-2xl -mr-10 -mt-10 pointer-events-none"></div>
         <div class="flex justify-between items-start relative z-10">
           <div class="flex gap-4">
             <div class="w-10 h-10 bg-white/20 backdrop-blur rounded-xl flex items-center justify-center shrink-0">
               <i class="fa-solid fa-calendar-check text-xl"></i>
             </div>
             <div>
               <p class="font-bold text-lg mb-1">{{ bannerConfig.text }}</p>
               <p class="text-blue-100 text-sm leading-relaxed max-w-lg">Ahora puedes adelantar tus pedidos para todos los d칤as disponibles. Navega por las pesta침as abajo.</p>
             </div>
           </div>
           <button @click="dismissBanner" class="text-white/60 hover:text-white bg-white/0 hover:bg-white/10 rounded-lg p-2 transition-all">
             <i class="fa-solid fa-xmark text-lg"></i>
           </button>
         </div>
      </div>

      <!-- Weekly Summary Dashboard -->
      <div v-if="userWeeklySummary.length > 0" class="bg-white rounded-3xl shadow-sm border border-gray-100 overflow-hidden animate-fade-in">
        <div class="px-6 py-4 border-b border-gray-50 flex justify-between items-center bg-gray-50/50">
             <h3 class="font-bold text-gray-800 text-sm flex items-center gap-2">
               <span class="w-2 h-2 rounded-full bg-blue-500"></span>
               Mi Resumen Semanal
             </h3>
        </div>
        <div class="overflow-x-auto">
           <div class="max-h-64 overflow-y-auto">
             <table class="w-full text-sm text-left border-collapse">
                <thead class="sticky top-0 bg-white z-10 shadow-sm">
                   <tr>
                      <th class="p-4 whitespace-nowrap text-xs font-bold text-gray-400 uppercase tracking-wider bg-white sticky left-0 z-20">D칤a</th>
                      <th v-for="h in summaryHeaders" :key="h" class="p-4 whitespace-nowrap text-xs font-bold text-gray-400 uppercase tracking-wider bg-white">
                        <i :class="getIconForCategory(h) + ' mr-1.5 opacity-50'"></i>{{ formatCatName(h) }}
                      </th>
                   </tr>
                </thead>
                <tbody class="divide-y divide-gray-50">
                   <tr v-for="row in userWeeklySummary" :key="row.date" class="hover:bg-blue-50/30 transition-colors group">
                      <td class="p-4 font-bold text-gray-800 whitespace-nowrap sticky left-0 bg-white group-hover:bg-blue-50/30 transition-colors shadow-[2px_0_5px_-2px_rgba(0,0,0,0.05)] border-r border-gray-50">
                        {{ row.label }}
                      </td>
                      <td v-for="h in summaryHeaders" :key="h" class="p-4 min-w-[140px]">
                         <div v-if="row.items[h]" class="text-xs font-semibold text-blue-700 bg-blue-50 border border-blue-100 px-3 py-1.5 rounded-lg inline-block leading-snug shadow-sm">
                            {{ row.items[h] }}
                         </div>
                         <span v-else class="text-gray-200 text-lg select-none">&middot;</span>
                      </td>
                   </tr>
                </tbody>
             </table>
           </div>
        </div>
      </div>

      <!-- Date Navigation (Tabs) -->
      <div v-if="dates.length > 0" class="border-b border-gray-100 flex gap-8 overflow-x-auto no-scrollbar">
        <button v-for="d in dates" :key="d.value"
          @click="changeDate(d.value)"
          :class="['pb-3 px-1 text-sm font-bold whitespace-nowrap transition-all border-b-2 outline-none',
            currentDate === d.value
            ? 'border-blue-600 text-blue-600'
            : 'border-transparent text-gray-400 hover:text-gray-600 hover:border-gray-200']">
          {{ d.label }}
        </button>
      </div>

      <div v-else-if="!loading" class="bg-amber-50 border border-amber-100 p-6 rounded-2xl text-amber-800 text-center flex flex-col items-center gap-3">
        <div class="w-12 h-12 bg-amber-100 rounded-full flex items-center justify-center text-xl">
          <i class="fa-solid fa-clock"></i>
        </div>
        <p class="font-medium">No hay fechas disponibles para ordenar. (Cierre 2:30 PM)</p>
      </div>

      <!-- Order Confirmed State (Receipt Style) -->
      <div v-if="myOrder" class="max-w-md mx-auto bg-white rounded-[2rem] shadow-xl shadow-green-900/5 overflow-hidden text-center relative mt-8 border border-gray-100 animate-fade-in-up">
        <!-- Success Header -->
        <div class="bg-gradient-to-br from-green-400 to-green-600 p-10 text-white relative overflow-hidden">
           <div class="w-24 h-24 bg-white/20 rounded-full absolute -top-10 -right-10 animate-pulse"></div>
           <div class="w-16 h-16 bg-white/10 rounded-full absolute bottom-5 left-5"></div>

           <div class="w-20 h-20 bg-white text-green-500 rounded-full flex items-center justify-center text-3xl mx-auto shadow-lg mb-6 animate-bounce-slow">
              <i class="fa-solid fa-check"></i>
           </div>
           <h2 class="text-2xl font-bold mb-1 tracking-tight">춰Pedido Confirmado!</h2>
           <p class="text-green-50 text-sm font-medium opacity-90">Tu almuerzo est치 asegurado</p>
        </div>

        <!-- Receipt Body -->
        <div class="p-8 relative">
           <!-- Perforation Effect -->
           <div class="absolute top-0 left-0 w-full h-4 -mt-2 z-10 bg-[radial-gradient(circle,transparent_50%,white_50%)] bg-[length:1rem_1rem] rotate-180"></div>

           <div class="space-y-6">
              <div class="flex justify-between items-center text-sm border-b border-gray-100 pb-4 border-dashed">
                 <span class="text-gray-400 font-medium">Fecha de Entrega</span>
                 <span class="font-bold text-gray-800 bg-gray-50 px-3 py-1 rounded-lg">{{ displayDate }}</span>
              </div>
              <div class="text-left">
                 <label class="text-xs text-gray-400 uppercase font-bold tracking-wider mb-2 block">Resumen del pedido</label>
                 <div class="bg-gray-50 p-5 rounded-2xl text-sm text-gray-700 font-medium leading-relaxed border border-gray-100">
                    {{ myOrder.resumen }}
                 </div>
              </div>
           </div>

           <div class="mt-8">
              <button v-if="!isCutoffPassed" @click="cancelOrder" class="w-full py-4 rounded-xl border-2 border-red-50 text-red-500 font-bold hover:bg-red-50 hover:border-red-100 transition-colors text-sm flex items-center justify-center gap-2 group">
                 <i class="fa-solid fa-trash-can opacity-70 group-hover:opacity-100"></i> Cancelar o modificar
              </button>
           </div>
        </div>
      </div>

      <!-- Menu Grid -->
      <div v-else class="animate-fade-in">
        <div v-if="!isCutoffPassed && menuLoaded" class="space-y-8">

          <!-- Category Pills (Sticky) -->
           <div class="sticky top-[4.5rem] bg-gray-50/95 backdrop-blur z-40 py-3 -mx-4 px-4 border-b border-gray-200/50 flex items-center group/pills">

             <!-- Scroll Indicators (Desktop) -->
             <button class="hidden md:block absolute left-0 z-10 p-2 bg-gradient-to-r from-gray-50 to-transparent text-gray-400 hover:text-gray-900 transition-colors" onclick="document.getElementById('cat-scroll').scrollBy({left: -200, behavior: 'smooth'})">
                <i class="fa-solid fa-chevron-left"></i>
             </button>

             <div id="cat-scroll" class="flex gap-3 overflow-x-auto no-scrollbar scroll-smooth px-8 w-full">
               <button v-for="cat in categories" :key="cat"
                 @click="scrollToCat(cat)"
                 :class="['flex items-center gap-2 px-5 py-2.5 rounded-full text-sm font-bold transition-all shadow-sm whitespace-nowrap active:scale-95 shrink-0',
                hasSelectionInCat(cat)
                ? 'bg-gray-900 text-white shadow-md'
                : 'bg-white text-gray-600 border border-gray-200 hover:bg-gray-100 hover:border-gray-300']">
              <i :class="getIconForCategory(cat)"></i> {{ formatCatName(cat) }}
            </button>
             </div>

             <button class="hidden md:block absolute right-0 z-10 p-2 bg-gradient-to-l from-gray-50 to-transparent text-gray-400 hover:text-gray-900 transition-colors" onclick="document.getElementById('cat-scroll').scrollBy({left: 200, behavior: 'smooth'})">
                <i class="fa-solid fa-chevron-right"></i>
             </button>
          </div>

          <!-- Category Sections -->
          <div v-for="cat in categories" :key="cat" :id="'cat-'+cat" class="scroll-mt-36">
            <h3 class="text-lg font-bold text-gray-900 mb-4 flex items-center">
              {{ formatCatName(cat) }}
              <span v-if="isCatDisabled(cat)" class="ml-3 text-[10px] uppercase font-bold text-red-500 bg-red-50 px-2 py-1 rounded-md tracking-wide">No disponible</span>
            </h3>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div v-for="item in menu[cat]" :key="item.id"
                   @click="toggleItem(cat, item)"
                   :class="['group relative bg-white p-5 rounded-2xl shadow-sm hover:shadow-md transition-all duration-300 border cursor-pointer flex justify-between gap-4',
                     isSelected(item.id) ? 'ring-2 ring-blue-600 border-transparent bg-blue-50/10' : 'border-gray-100 hover:border-gray-200',
                     isItemDisabled(cat, item) ? 'opacity-50 pointer-events-none grayscale bg-gray-50' : ''
                   ]">
                <div class="flex-grow">
                  <div class="font-bold text-gray-900 text-base mb-1 group-hover:text-blue-700 transition-colors">{{ item.plato }}</div>
                  <div class="text-sm text-gray-500 leading-relaxed">{{ item.desc }}</div>
                </div>
                <div class="flex-shrink-0 pt-1">
                   <div :class="['w-8 h-8 rounded-full flex items-center justify-center transition-all duration-300 transform',
                     isSelected(item.id) ? 'bg-blue-600 text-white scale-110 shadow-lg shadow-blue-500/30' : 'bg-gray-100 text-gray-400 group-hover:bg-blue-100 group-hover:text-blue-600']">
                      <i :class="isSelected(item.id) ? 'fa-solid fa-check' : 'fa-solid fa-plus'"></i>
                   </div>
                </div>
              </div>
            </div>

            <div v-if="cat === 'Granos' && showGrainWarning" class="mt-3 p-3 bg-amber-50 text-amber-700 text-xs font-semibold rounded-xl flex items-center gap-2 animate-pulse border border-amber-100">
              <i class="fa-solid fa-circle-exclamation text-amber-500 text-sm"></i>
              Recuerda: Los granos requieren seleccionar Arroz Blanco.
            </div>
          </div>

          <!-- Comments Area -->
          <div class="bg-white p-5 rounded-2xl border border-gray-100 shadow-sm mt-8">
            <label class="block text-sm font-bold text-gray-900 mb-2">Nota para la cocina <span class="text-gray-400 font-normal">(Opcional)</span></label>
            <textarea v-model="comments" rows="2" class="w-full bg-gray-50 border-gray-200 rounded-xl focus:border-blue-500 focus:ring-blue-500 focus:bg-white transition-all text-sm p-3" placeholder="Ej: Sin cebolla, por favor..."></textarea>
          </div>

        </div>

        <div v-if="!menuLoaded && !loading" class="py-20 text-center text-gray-400">
          <div class="w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl">
             <i class="fa-solid fa-utensils opacity-50"></i>
          </div>
          <p class="font-medium">No hay men칰 disponible para esta fecha.</p>
        </div>

        <!-- Sticky Bottom Action Bar -->
        <!-- Logic: Sticky bottom by default (fixed), but if we scroll to bottom of container (past content), it should dock?
             Actually, standard fixed bottom bar is best for UX on mobile and desktop unless it covers content.
             We add padding-bottom to the main container to ensure content isn't covered.
             The user request "stop being sticky when scroll reaches position... below notes" implies it should sit inline at the end.
             However, implementing complex intersection logic in simple vue template is risky.
             Alternative: Just place it inline below notes, but make it sticky ONLY if it would be off-screen?
             CSS 'sticky' with bottom:0 works if inside a container. But typically sticky works for top.
             For bottom sticky: position: sticky; bottom: 0; only works if there is space *below* it in the parent.
             If we want it "Fixed until we reach bottom", that's JS.

             Let's try standard 'sticky bottom-0' inside the relative container.
             It will stick to the bottom of the viewport as long as we are inside the parent.
             Once we scroll past the parent, it scrolls away? No, that's not how it works.

             Let's implement it as FIXED (current state) because it guarantees visibility.
             The user said "Deber칤a de quedarse ah칤 cuando el scroll llegue a su posici칩n".
             This means: Inline position at end of form. But if form is long, pin it to bottom of screen.
             This requires 'sticky' position with a bottom threshold?
             Actually, 'position: sticky; bottom: 0;' creates a sticky element that sticks to the bottom of the viewport
             UNTIL the bottom of its parent container is reached.
             So if we put this div INSIDE the main content wrapper (User View), at the end, it should work!
        -->
        <div v-if="!isCutoffPassed && menuLoaded" class="sticky bottom-4 z-50 mt-8">
           <div class="bg-white/90 backdrop-blur-md border border-gray-200 p-4 rounded-2xl shadow-2xl flex flex-col md:flex-row gap-3 items-center">
             <div v-if="validationError" class="w-full md:w-auto flex-grow bg-red-50 text-red-600 px-4 py-3 rounded-xl text-sm font-semibold flex items-center justify-center md:justify-start gap-2 animate-shake">
                <i class="fa-solid fa-circle-xmark"></i> {{ validationError }}
             </div>
             <button @click="submitOrder" :disabled="submitting || hasBlockingErrors"
               class="w-full md:w-auto md:min-w-[300px] ml-auto bg-gray-900 hover:bg-black disabled:bg-gray-300 disabled:cursor-not-allowed text-white font-bold py-4 px-8 rounded-xl shadow-lg shadow-gray-900/20 transition-all active:scale-95 flex justify-center items-center gap-3 text-base">
               <span v-if="submitting"><i class="fa-solid fa-circle-notch fa-spin"></i> Procesando...</span>
               <span v-else>
                  Confirmar Pedido
                  <span v-if="selectedCount > 0" class="ml-2 bg-white/20 px-2 py-0.5 rounded-md text-sm">{{ selectedCount }}</span>
               </span>
             </button>
           </div>
        </div>
      </div>
      </div> <!-- End User View -->

      <!-- ADMIN VIEW -->
      <div v-if="viewMode === 'ADMIN'" class="relative animate-fade-in min-h-[500px]">

         <!-- Admin Spinner -->
         <div v-if="adminState.loading" class="absolute inset-0 bg-white/80 backdrop-blur-sm z-50 flex items-center justify-center rounded-3xl transition-all">
            <div class="flex flex-col items-center gap-3">
               <div class="w-12 h-12 border-4 border-blue-100 border-t-blue-600 rounded-full animate-spin"></div>
               <span class="text-xs font-bold text-blue-600 uppercase tracking-widest animate-pulse">Cargando...</span>
            </div>
         </div>

         <!-- Navigation -->
         <div class="flex gap-1 border-b border-gray-200 mb-6 overflow-x-auto no-scrollbar pb-1">
            <button v-for="tab in ['USUARIOS', 'PEDIDOS']" :key="tab"
               @click="adminState.tab = tab"
               :class="['px-4 py-2 font-bold text-xs rounded-t-lg border-b-2 transition-all whitespace-nowrap', adminState.tab === tab ? 'border-blue-600 text-blue-600 bg-blue-50/50' : 'border-transparent text-gray-500 hover:text-gray-700 hover:bg-gray-50']">
               {{ tab }}
            </button>
            <template v-if="isAdminGen">
               <button v-for="tab in ['DEPTOS', 'CONFIG', 'MENU', 'DIAS_LIBRES']" :key="tab"
                  @click="adminState.tab = tab"
                  :class="['px-4 py-2 font-bold text-xs rounded-t-lg border-b-2 transition-all whitespace-nowrap', adminState.tab === tab ? 'border-blue-600 text-blue-600 bg-blue-50/50' : 'border-transparent text-gray-500 hover:text-gray-700 hover:bg-gray-50']">
                  {{ tab === 'DIAS_LIBRES' ? 'CALENDARIO' : tab }}
               </button>
            </template>
         </div>

         <!-- Users Module -->
         <div v-if="adminState.tab === 'USUARIOS'" class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
            <div class="flex flex-col md:flex-row md:justify-between md:items-center gap-4 mb-4">
               <div class="flex items-center gap-2 w-full md:w-auto">
                 <div class="relative w-full md:w-64">
                    <i class="fa-solid fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-xs"></i>
                    <input v-model="adminState.filters.users.search" type="text" placeholder="Buscar usuario..." class="w-full bg-gray-50 border border-gray-200 text-xs rounded-lg pl-9 pr-8 py-2 focus:ring-2 focus:ring-blue-500 outline-none">
                    <button v-if="adminState.filters.users.search" @click="clearFilters('users')" class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600"><i class="fa-solid fa-xmark"></i></button>
                 </div>
               </div>
               <button @click="openUserModal()" class="bg-gray-900 hover:bg-gray-800 text-white text-xs font-bold py-2 px-4 rounded-lg flex items-center gap-2 shrink-0">
                 <i class="fa-solid fa-plus"></i> Usuario
               </button>
            </div>
            <div class="overflow-x-auto">
               <table class="w-full text-sm text-left">
                  <thead class="bg-gray-50 text-gray-500 font-bold uppercase text-xs">
                     <tr><th class="p-3 rounded-l">Nombre</th><th class="p-3">Correo</th><th class="p-3">Depto</th><th class="p-3">Rol</th><th class="p-3">Estado</th><th class="p-3 rounded-r">Acciones</th></tr>
                  </thead>
                  <tbody class="divide-y divide-gray-100">
                     <tr v-for="u in filteredUsers" :key="u.email" class="hover:bg-gray-50">
                        <td class="p-3 font-medium text-gray-900">{{ u.nombre }}</td>
                        <td class="p-3 text-gray-500">{{ u.email }}</td>
                        <td class="p-3"><span class="bg-gray-100 px-2 py-1 rounded text-xs font-semibold text-gray-600">{{ u.departamento }}</span></td>
                        <td class="p-3"><span class="bg-blue-50 text-blue-600 px-2 py-1 rounded text-xs font-bold">{{ u.rol }}</span></td>
                        <td class="p-3">
                           <span :class="['px-2 py-1 rounded-full text-xs font-bold', u.estado === 'ACTIVO' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700']">{{ u.estado }}</span>
                        </td>
                        <td class="p-3 flex gap-2">
                           <button @click="openUserModal(u)" class="text-blue-600 hover:bg-blue-50 p-1.5 rounded" title="Editar"><i class="fa-solid fa-pen"></i></button>
                           <button @click="toggleUserStatus(u)" :class="[u.estado==='ACTIVO'?'text-red-500 hover:bg-red-50':'text-green-600 hover:bg-green-50', 'p-1.5 rounded']" :title="u.estado==='ACTIVO'?'Desactivar':'Activar'">
                              <i :class="['fa-solid', u.estado==='ACTIVO' ? 'fa-ban' : 'fa-check']"></i>
                           </button>
                        </td>
                     </tr>
                  </tbody>
               </table>
            </div>
         </div>

         <!-- Orders Module -->
         <div v-if="adminState.tab === 'PEDIDOS'" class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
             <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-900">Pedidos</h2>
                <div class="flex gap-2">
                   <button v-if="adminState.filters.orders.search || adminState.filters.orders.dateStart || adminState.filters.orders.status" @click="clearFilters('orders')" class="text-red-500 hover:bg-red-50 text-xs font-bold py-2 px-3 rounded-lg transition-colors">
                      <i class="fa-solid fa-trash-can mr-1"></i> Limpiar
                   </button>
                   <button @click="adminState.filters.orders.open = !adminState.filters.orders.open" class="bg-gray-100 hover:bg-gray-200 text-gray-600 text-xs font-bold py-2 px-4 rounded-lg flex items-center gap-2">
                     <i class="fa-solid fa-filter"></i> Filtros
                   </button>
                </div>
             </div>

             <!-- Filter Bar -->
             <div v-if="adminState.filters.orders.open" class="bg-gray-50 p-4 rounded-xl border border-gray-200 mb-4 grid grid-cols-1 md:grid-cols-4 gap-3 animate-fade-in">
                <input v-model="adminState.filters.orders.search" type="text" placeholder="Buscar por texto..." class="bg-white border border-gray-200 rounded-lg px-3 py-2 text-xs focus:ring-1 focus:ring-blue-500 outline-none">
                <input v-model="adminState.filters.orders.dateStart" type="date" title="Desde" class="bg-white border border-gray-200 rounded-lg px-3 py-2 text-xs focus:ring-1 focus:ring-blue-500 outline-none">
                <input v-model="adminState.filters.orders.dateEnd" type="date" title="Hasta" class="bg-white border border-gray-200 rounded-lg px-3 py-2 text-xs focus:ring-1 focus:ring-blue-500 outline-none">
                <select v-model="adminState.filters.orders.status" class="bg-white border border-gray-200 rounded-lg px-3 py-2 text-xs focus:ring-1 focus:ring-blue-500 outline-none">
                   <option value="">Todos los Estados</option>
                   <option value="ACTIVO">Activo</option>
                   <option value="CANCELADO">Cancelado</option>
                </select>
             </div>

             <div class="overflow-x-auto">
               <table class="w-full text-sm text-left">
                  <thead class="bg-gray-50 text-gray-500 font-bold uppercase text-xs">
                     <tr><th class="p-3 rounded-l">Fecha</th><th class="p-3">Usuario</th><th class="p-3">Resumen</th><th class="p-3">Creado Por</th><th class="p-3">Estado</th><th class="p-3 rounded-r">Acciones</th></tr>
                  </thead>
                  <tbody>
                     <tr v-for="o in filteredOrders" :key="o.id" class="border-b last:border-0 hover:bg-gray-50">
                        <td class="p-3 whitespace-nowrap font-medium text-gray-900">{{ o.date.split('-').slice(1).reverse().join('/') }}</td>
                        <td class="p-3">
                           <div class="font-bold text-gray-900">{{ o.nombre }}</div>
                           <div class="text-xs text-gray-400">{{ o.email }}</div>
                        </td>
                        <td class="p-3 text-gray-600">{{ o.resumen }}</td>
                        <td class="p-3 text-xs text-gray-400">{{ o.creado_por === o.email ? '(Mismo)' : o.creado_por }}</td>
                        <td class="p-3"><span class="bg-blue-50 text-blue-700 px-2 py-1 rounded text-xs font-bold">{{ o.estado }}</span></td>
                        <td class="p-3">
                           <button @click="adminCancelOrder(o.id)" class="text-red-500 hover:bg-red-50 p-2 rounded text-xs font-bold border border-red-100">
                             Cancelar
                           </button>
                        </td>
                     </tr>
                  </tbody>
               </table>
             </div>
         </div>

         <!-- Depts Module (Admin Gen) -->
         <div v-if="adminState.tab === 'DEPTOS'" class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
            <div class="flex justify-between items-center mb-4">
               <h2 class="text-xl font-bold text-gray-900">Departamentos</h2>
               <button @click="openDeptModal()" class="bg-gray-900 hover:bg-gray-800 text-white text-xs font-bold py-2 px-4 rounded-lg flex items-center gap-2">
                 <i class="fa-solid fa-plus"></i> Depto
               </button>
            </div>
            <div class="overflow-x-auto">
               <table class="w-full text-sm text-left">
                  <thead class="bg-gray-50 text-gray-500 font-bold uppercase text-xs">
                     <tr><th class="p-3 rounded-l">Nombre</th><th class="p-3">Admins (Emails)</th><th class="p-3">Estado</th><th class="p-3 rounded-r">Acciones</th></tr>
                  </thead>
                  <tbody class="divide-y divide-gray-100">
                     <tr v-for="d in adminState.departments" :key="d.id" class="hover:bg-gray-50">
                        <td class="p-3 font-medium text-gray-900">{{ d.nombre }}</td>
                        <td class="p-3 text-gray-500 text-xs truncate max-w-xs">{{ d.admins }}</td>
                        <td class="p-3"><span :class="['px-2 py-1 rounded-full text-xs font-bold', d.estado === 'ACTIVO' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700']">{{ d.estado }}</span></td>
                        <td class="p-3 flex gap-2">
                           <button @click="openDeptModal(d)" class="text-blue-600 hover:bg-blue-50 p-1.5 rounded" title="Editar"><i class="fa-solid fa-pen"></i></button>
                           <button @click="deleteDept(d.id)" class="text-red-500 hover:bg-red-50 p-1.5 rounded" title="Eliminar"><i class="fa-solid fa-trash"></i></button>
                        </td>
                     </tr>
                  </tbody>
               </table>
            </div>
         </div>

         <!-- Config Module -->
         <div v-if="adminState.tab === 'CONFIG'" class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
            <div v-if="!isAdminGen" class="text-center py-10 text-gray-400">
               <i class="fa-solid fa-lock text-3xl mb-3"></i>
               <p>Solo el Administrador General puede editar la configuraci칩n.</p>
            </div>
            <div v-else>
               <div class="flex justify-between items-center mb-6">
                  <h2 class="text-xl font-bold text-gray-900">Variables del Sistema</h2>
                  <div class="flex gap-2">
                     <button v-if="adminState.configEdit" @click="adminState.configEdit = false" class="text-gray-500 hover:bg-gray-100 text-xs font-bold py-2 px-4 rounded-lg">Cancelar</button>
                     <button v-if="adminState.configEdit" @click="saveConfig" class="bg-blue-600 hover:bg-blue-700 text-white text-xs font-bold py-2 px-4 rounded-lg">Guardar</button>
                     <button v-if="!adminState.configEdit" @click="adminState.configEdit = true" class="text-blue-600 hover:bg-blue-50 text-xs font-bold py-2 px-4 rounded-lg"><i class="fa-solid fa-pen"></i> Editar</button>
                  </div>
               </div>

               <!-- Customized Inputs for specific keys -->
               <div class="grid gap-4 md:grid-cols-2">
                  <div v-for="item in adminState.configList" :key="item.key" v-show="item.key !== 'RESPONSIBLES_EMAILS_JSON'" class="bg-gray-50 p-4 rounded-xl border border-gray-200">
                     <div class="flex justify-between items-start mb-2">
                        <div class="text-xs font-bold text-gray-500 uppercase tracking-wider">{{ item.key }}</div>
                        <div class="text-[10px] text-gray-400 max-w-[50%] text-right leading-tight">{{ item.desc }}</div>
                     </div>

                     <div v-if="!adminState.configEdit" class="font-mono text-sm text-gray-900 font-medium break-all bg-white px-3 py-2 rounded-lg border border-transparent">
                        {{ adminState.config[item.key] }}
                     </div>
                     <div v-else>
                        <input v-if="item.key === 'HORA_ENVIO' || item.key === 'HORA_RECORDATORIO'" type="time" v-model="adminState.config[item.key]" class="w-full bg-white border border-gray-200 rounded-lg px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-blue-500">
                        <input v-else-if="item.key.includes('LIMIT') || item.key.includes('MINUTOS')" type="number" v-model="adminState.config[item.key]" class="w-full bg-white border border-gray-200 rounded-lg px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-blue-500">
                        <input v-else type="text" v-model="adminState.config[item.key]" class="w-full bg-white border border-gray-200 rounded-lg px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-blue-500">

                        <p v-if="item.key === 'HORA_ENVIO'" class="mt-1 text-[10px] text-amber-600 flex items-center gap-1"><i class="fa-solid fa-triangle-exclamation"></i> Actualizar Trigger manualmente.</p>
                     </div>
                  </div>
               </div>

               <!-- Responsibles Editor -->
               <div class="mt-8">
                  <h3 class="font-bold text-sm text-gray-900 mb-4 flex items-center gap-2">
                     <i class="fa-solid fa-users-gear text-gray-400"></i> Responsables (Reportes Diarios)
                  </h3>
                  <div class="bg-gray-50 border border-gray-200 rounded-xl overflow-hidden p-4">
                     <p class="text-xs text-gray-500 mb-4">Estos usuarios recibir치n los reportes de TODOS los departamentos.</p>

                     <div class="space-y-3">
                        <div v-for="(r, idx) in adminState.responsiblesList" :key="idx" class="flex gap-2 items-center">
                           <input :disabled="!adminState.configEdit" v-model="r.name" type="text" placeholder="Nombre" class="w-1/3 bg-white border border-gray-200 rounded px-2 py-1.5 text-xs outline-none focus:ring-1 focus:ring-blue-500">
                           <input :disabled="!adminState.configEdit" v-model="r.email" type="email" placeholder="Correo" class="w-1/3 bg-white border border-gray-200 rounded px-2 py-1.5 text-xs outline-none focus:ring-1 focus:ring-blue-500">
                           <select :disabled="!adminState.configEdit" v-model="r.type" class="w-1/4 bg-white border border-gray-200 rounded px-2 py-1.5 text-xs outline-none">
                              <option value="TO">Principal (Para)</option>
                              <option value="CC">Copia (CC)</option>
                           </select>
                           <button v-if="adminState.configEdit" @click="removeResponsible(idx)" class="text-red-500 hover:bg-red-50 p-1.5 rounded"><i class="fa-solid fa-trash"></i></button>
                        </div>
                     </div>

                     <button v-if="adminState.configEdit" @click="addResponsible" class="mt-4 text-blue-600 hover:bg-blue-50 text-xs font-bold py-2 px-4 rounded-lg flex items-center gap-2">
                        <i class="fa-solid fa-plus"></i> Agregar Responsable
                     </button>
                  </div>
               </div>
            </div>
         </div>

         <!-- Menu Module (New) -->
         <div v-if="adminState.tab === 'MENU'" class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
            <h2 class="text-xl font-bold text-gray-900 mb-4">Gesti칩n de Men칰</h2>
            <div class="flex gap-4 mb-6 items-end">
               <div>
                  <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Fecha</label>
                  <input type="date" v-model="adminState.menuDate" @change="checkMenuDate" :min="adminState.nextBusinessDay" class="bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-blue-500">
               </div>
               <div v-if="adminState.menuDate" class="text-sm text-gray-500 pb-2">
                  Editando men칰 para: <b>{{ adminState.menuDate }}</b>
               </div>
            </div>

            <div v-if="!adminState.menuDate" class="text-center py-10 text-gray-400 bg-gray-50 rounded-xl border border-dashed border-gray-200">
               <i class="fa-solid fa-calendar-days text-3xl mb-2"></i>
               <p>Selecciona una fecha para editar.</p>
            </div>

            <div v-else class="space-y-6">
               <div v-for="cat in categories" :key="cat" class="border border-gray-200 rounded-xl overflow-hidden">
                  <div class="bg-gray-50 px-4 py-3 flex justify-between items-center">
                     <h3 class="font-bold text-sm text-gray-800 flex items-center gap-2">
                        <i :class="getIconForCategory(cat)"></i> {{ formatCatName(cat) }}
                     </h3>
                     <button @click="openMenuModal(null, cat)" class="text-blue-600 hover:bg-blue-100 p-1.5 rounded text-xs font-bold transition-colors">
                        <i class="fa-solid fa-plus"></i> Agregar
                     </button>
                  </div>
                  <div class="divide-y divide-gray-100">
                     <div v-for="item in adminState.menuItems.filter(i => i.cat === cat)" :key="item.id" class="p-4 flex justify-between items-start hover:bg-gray-50/50 group">
                        <div>
                           <div class="font-bold text-sm text-gray-900">{{ item.plato }}</div>
                           <div class="text-xs text-gray-500">{{ item.desc }}</div>
                        </div>
                        <div class="flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                           <button @click="openMenuModal(item, cat)" class="text-gray-400 hover:text-blue-600"><i class="fa-solid fa-pen"></i></button>
                           <button @click="deleteMenuItem(item.id)" class="text-gray-400 hover:text-red-500"><i class="fa-solid fa-trash"></i></button>
                        </div>
                     </div>
                     <div v-if="!adminState.menuItems.some(i => i.cat === cat)" class="p-4 text-xs text-gray-400 italic">
                        Sin opciones.
                     </div>
                  </div>
               </div>
            </div>
         </div>

         <!-- Holidays Module (New) -->
         <div v-if="adminState.tab === 'DIAS_LIBRES'" class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
            <h2 class="text-xl font-bold text-gray-900 mb-4">D칤as Libres (Feriados)</h2>
            <div class="flex flex-col md:flex-row gap-4 mb-6 bg-gray-50 p-4 rounded-xl border border-gray-200">
               <input v-model="adminState.holidayModal.data.date" type="date" class="bg-white border border-gray-200 rounded-lg px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-blue-500">
               <input v-model="adminState.holidayModal.data.desc" type="text" placeholder="Descripci칩n (ej. Navidad)" class="flex-grow bg-white border border-gray-200 rounded-lg px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-blue-500">
               <button @click="saveHoliday" class="bg-gray-900 hover:bg-black text-white font-bold py-2 px-6 rounded-lg text-sm transition-colors">Agregar</button>
            </div>

            <div class="overflow-x-auto">
               <table class="w-full text-sm text-left">
                  <thead class="bg-gray-50 text-gray-500 font-bold uppercase text-xs">
                     <tr><th class="p-3 rounded-l">Fecha</th><th class="p-3">Motivo</th><th class="p-3 rounded-r">Acciones</th></tr>
                  </thead>
                  <tbody class="divide-y divide-gray-100">
                     <tr v-for="h in adminState.holidays" :key="h.date" class="hover:bg-gray-50">
                        <td class="p-3 font-medium text-gray-900">{{ h.date.split('-').reverse().join('/') }}</td>
                        <td class="p-3 text-gray-600">{{ h.desc }}</td>
                        <td class="p-3">
                           <button @click="deleteHoliday(h.date)" class="text-red-500 hover:bg-red-50 p-2 rounded text-xs font-bold border border-red-100">
                             Eliminar
                           </button>
                        </td>
                     </tr>
                     <tr v-if="adminState.holidays.length === 0">
                        <td colspan="3" class="p-4 text-center text-gray-400">No hay d칤as libres futuros registrados.</td>
                     </tr>
                  </tbody>
               </table>
            </div>
         </div>

      </div>
    </main>

    <!-- Admin User Modal -->
    <div v-if="adminState.userModal.open" class="fixed inset-0 z-[70] flex items-center justify-center p-4">
       <div class="absolute inset-0 bg-gray-900/50 backdrop-blur-sm" @click="adminState.userModal.open = false"></div>
       <div class="bg-white rounded-2xl shadow-xl w-full max-w-md relative overflow-hidden animate-fade-in-up">
          <div class="px-6 py-4 border-b border-gray-100 flex justify-between items-center bg-gray-50">
             <h3 class="font-bold text-lg text-gray-800">{{ adminState.userModal.isNew ? 'Nuevo Usuario' : 'Editar Usuario' }}</h3>
             <button @click="adminState.userModal.open = false" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-xmark"></i></button>
          </div>
          <div class="p-6 space-y-4">
             <div>
                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Correo</label>
                <input v-model="adminState.userModal.data.email" :disabled="!adminState.userModal.isNew" type="email" class="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none disabled:opacity-50">
             </div>
             <div>
                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Nombre</label>
                <input v-model="adminState.userModal.data.nombre" type="text" class="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
             </div>
             <div>
                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Departamento</label>
                <select v-if="isAdminGen" v-model="adminState.userModal.data.departamento" class="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                   <option v-for="d in adminState.departments" :key="d.id" :value="d.id">{{ d.nombre }}</option>
                </select>
                <input v-else v-model="adminState.userModal.data.departamento" disabled type="text" class="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none opacity-50">
             </div>
             <div v-if="isAdminGen">
                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Rol</label>
                <select v-model="adminState.userModal.data.rol" class="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                   <option value="USER">Usuario</option>
                   <option value="ADMIN_DEP">Admin Depto</option>
                   <option value="ADMIN_GEN">Admin General</option>
                </select>
             </div>
          </div>
          <div class="px-6 py-4 bg-gray-50 border-t border-gray-100 flex justify-end gap-3">
             <button @click="adminState.userModal.open = false" class="px-4 py-2 rounded-lg text-sm font-bold text-gray-500 hover:bg-gray-200 transition-colors">Cancelar</button>
             <button @click="saveUser" class="px-4 py-2 rounded-lg text-sm font-bold bg-gray-900 text-white hover:bg-black transition-colors">Guardar</button>
          </div>
       </div>
    </div>

    <!-- Dept Modal -->
    <div v-if="adminState.deptModal.open" class="fixed inset-0 z-[70] flex items-center justify-center p-4">
       <div class="absolute inset-0 bg-gray-900/50 backdrop-blur-sm" @click="adminState.deptModal.open = false"></div>
       <div class="bg-white rounded-2xl shadow-xl w-full max-w-md relative overflow-hidden animate-fade-in-up">
          <div class="px-6 py-4 border-b border-gray-100 flex justify-between items-center bg-gray-50">
             <h3 class="font-bold text-lg text-gray-800">{{ adminState.deptModal.isNew ? 'Nuevo Departamento' : 'Editar Departamento' }}</h3>
             <button @click="adminState.deptModal.open = false" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-xmark"></i></button>
          </div>
          <div class="p-6 space-y-4">
             <div>
                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Nombre</label>
                <input v-model="adminState.deptModal.data.nombre" type="text" class="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
             </div>
             <div>
                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Admins</label>
                <div class="flex flex-wrap gap-2 mb-2 min-h-[30px] p-2 bg-gray-50 border border-gray-200 rounded-lg">
                   <span v-for="email in (adminState.deptModal.data.admins ? adminState.deptModal.data.admins.split(',').map(e=>e.trim()).filter(e=>e) : [])" :key="email" class="bg-white border border-gray-200 px-2 py-1 rounded text-xs flex items-center gap-2 shadow-sm">
                      <span class="font-semibold">{{ email }}</span>
                      <button @click="removeDeptAdmin(email)" class="text-gray-400 hover:text-red-500 w-4 h-4 flex items-center justify-center rounded-full hover:bg-red-50"><i class="fa-solid fa-xmark"></i></button>
                   </span>
                   <span v-if="!adminState.deptModal.data.admins" class="text-gray-400 text-xs italic">Sin administradores.</span>
                </div>
                <div class="relative">
                   <input v-model="deptAdminSearch" type="text" class="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Buscar usuario para agregar...">
                   <div v-if="deptAdminSearch && filteredAdminUsers.length > 0" class="absolute top-full left-0 w-full bg-white border border-gray-100 rounded-lg shadow-lg z-10 max-h-40 overflow-y-auto mt-1">
                      <button v-for="u in filteredAdminUsers" :key="u.email" @click="addDeptAdmin(u); deptAdminSearch=''" class="w-full text-left px-3 py-2 text-xs hover:bg-gray-50 flex justify-between items-center border-b border-gray-50 last:border-0">
                         <span class="font-bold text-gray-800">{{ u.nombre }}</span>
                         <span class="text-gray-400">{{ u.email }}</span>
                      </button>
                   </div>
                </div>

                <div v-if="deptMoveHint.length > 0" class="mt-2 p-2 bg-amber-50 border border-amber-100 rounded-lg animate-fade-in">
                   <p class="text-[10px] font-bold text-amber-700 mb-1 flex items-center gap-1"><i class="fa-solid fa-triangle-exclamation"></i> Atenci칩n: Usuarios que cambiar치n de depto</p>
                   <ul class="text-[10px] text-amber-600 list-disc list-inside">
                      <li v-for="msg in deptMoveHint" :key="msg">{{ msg }}</li>
                   </ul>
                </div>
             </div>
             <div>
                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Estado</label>
                <select v-model="adminState.deptModal.data.estado" class="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                   <option value="ACTIVO">ACTIVO</option>
                   <option value="INACTIVO">INACTIVO</option>
                </select>
             </div>
          </div>
          <div class="px-6 py-4 bg-gray-50 border-t border-gray-100 flex justify-end gap-3">
             <button @click="adminState.deptModal.open = false" class="px-4 py-2 rounded-lg text-sm font-bold text-gray-500 hover:bg-gray-200 transition-colors">Cancelar</button>
             <button @click="saveDept" class="px-4 py-2 rounded-lg text-sm font-bold bg-gray-900 text-white hover:bg-black transition-colors">Guardar</button>
          </div>
       </div>
    </div>

    <!-- Menu Modal (New) -->
    <div v-if="adminState.menuModal.open" class="fixed inset-0 z-[70] flex items-center justify-center p-4">
       <div class="absolute inset-0 bg-gray-900/50 backdrop-blur-sm" @click="adminState.menuModal.open = false"></div>
       <div class="bg-white rounded-2xl shadow-xl w-full max-w-sm relative overflow-hidden animate-fade-in-up">
          <div class="px-6 py-4 border-b border-gray-100 flex justify-between items-center bg-gray-50">
             <h3 class="font-bold text-lg text-gray-800">{{ adminState.menuModal.isNew ? 'Nuevo Plato' : 'Editar Plato' }}</h3>
             <button @click="adminState.menuModal.open = false" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-xmark"></i></button>
          </div>
          <div class="p-6 space-y-4">
             <div>
                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Categor칤a</label>
                <select v-model="adminState.menuModal.data.cat" disabled class="w-full bg-gray-100 border border-gray-200 rounded-lg px-3 py-2 text-sm outline-none opacity-70 cursor-not-allowed">
                   <option v-for="c in categories" :key="c" :value="c">{{ formatCatName(c) }}</option>
                </select>
             </div>
             <div>
                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Nombre del Plato</label>
                <input v-model="adminState.menuModal.data.plato" type="text" class="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
             </div>
             <div>
                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Descripci칩n</label>
                <textarea v-model="adminState.menuModal.data.desc" rows="3" class="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none"></textarea>
             </div>
          </div>
          <div class="px-6 py-4 bg-gray-50 border-t border-gray-100 flex justify-end gap-3">
             <button @click="adminState.menuModal.open = false" class="px-4 py-2 rounded-lg text-sm font-bold text-gray-500 hover:bg-gray-200 transition-colors">Cancelar</button>
             <button @click="saveMenuItem" class="px-4 py-2 rounded-lg text-sm font-bold bg-gray-900 text-white hover:bg-black transition-colors">Guardar</button>
          </div>
       </div>
    </div>

    <!-- Footer -->
    <footer class="mt-auto py-10 bg-white border-t border-gray-100">
      <div class="max-w-4xl mx-auto px-4 relative flex flex-col items-center justify-center gap-4">
        <? if (signatureUrl) { ?>
          <img src="<?!= signatureUrl ?>" alt="Sello" class="h-10 w-auto object-contain opacity-50 grayscale hover:grayscale-0 transition-all duration-500" />
        <? } ?>
        <div class="text-center text-[10px] text-gray-400 font-bold tracking-widest uppercase">
           Direcci칩n de Innovaci칩n &copy; 2025
        </div>
      </div>
    </footer>
  </div>
  <script>
const { createApp, ref, computed, onMounted, reactive } = Vue;

createApp({
  setup() {
    // === ESTADO (STATE) ===
    const loading = ref(true);
    const submitting = ref(false);

    // Datos del usuario y app
    const user = ref({});
    const activeUser = ref({});
    const deptUsers = ref([]);
    const impersonateEmail = ref('');
    const menu = ref({});
    const myOrder = ref(null);
    const adminData = ref(null);

    // Manejo de Fechas (Nuevo)
    const currentDate = ref(''); // Fecha seleccionada actualmente (YYYY-MM-DD)
    const dates = ref([]);       // Lista de fechas disponibles (tabs)
    const allMenus = ref({});
    const allOrders = ref({});
    const remindersEnabled = ref(true);
    const showMultiDayBanner = ref(false);
    const bannerConfig = ref({ text: '', limit: 5 });

    // Formulario
    const comments = ref('');
    const selection = reactive(new Set());
    const selectionData = reactive({});

    const deptAdminSearch = ref('');

    // ADMIN STATE
    const viewMode = ref('USER'); // USER | ADMIN
    const adminState = reactive({
       loading: false,
       tab: 'USUARIOS',
       users: [],
       orders: [],
       departments: [],
       deptMap: {}, // ID -> Name
       config: {},
       configList: [],
       configKeys: [],
       holidays: [],
       userModal: { open: false, isNew: true, data: {} },
       deptModal: { open: false, isNew: true, data: {} },
       configEdit: false,
       filters: {
          orders: { search: '', dateStart: '', dateEnd: '', status: '', open: false },
          users: { search: '' }
       },
       // Menu Editor
       menuDate: '',
       menuItems: [],
       menuModal: { open: false, isNew: true, data: {} },
       // Holiday Editor
       holidayModal: { open: false, data: {} },
       nextBusinessDay: '',
       responsiblesList: []
    });

    // === COMPUTED PROPERTIES ===
    const isAdmin = computed(() => activeUser.value.rol && ['ADMIN_GEN', 'ADMIN_DEP'].includes(activeUser.value.rol));
    const isDeptAdmin = computed(() => activeUser.value.rol === 'ADMIN_DEP');
    const isAdminGen = computed(() => activeUser.value.rol === 'ADMIN_GEN');

    const menuLoaded = computed(() => menu.value && Object.keys(menu.value).length > 0);

    // FILTERED LISTS
    const filteredUsers = computed(() => {
       const q = adminState.filters.users.search.toLowerCase();
       if (!q) return adminState.users;
       return adminState.users.filter(u =>
          u.nombre.toLowerCase().includes(q) ||
          u.email.toLowerCase().includes(q) ||
          u.departamento.toLowerCase().includes(q)
       );
    });

    const filteredAdminUsers = computed(() => {
       const q = deptAdminSearch.value.toLowerCase();
       if (!q) return [];
       return adminState.users.filter(u =>
          u.nombre.toLowerCase().includes(q) || u.email.toLowerCase().includes(q)
       );
    });

    const deptMoveHint = computed(() => {
       if (!adminState.deptModal.data.admins) return [];
       const emails = adminState.deptModal.data.admins.split(',').map(e=>e.trim().toLowerCase());
       const moved = [];
       const targetId = adminState.deptModal.data.id;

       emails.forEach(e => {
          const u = adminState.users.find(x => x.email.toLowerCase() === e);
          if (u && u.rol === 'ADMIN_DEP' && (!targetId || u.departamentoId !== targetId)) {
             const oldName = adminState.deptMap[u.departamentoId] || 'Otro';
             moved.push(`${u.nombre} se mover치 de ${oldName}`);
          }
       });
       return moved;
    });

    const filteredOrders = computed(() => {
       const f = adminState.filters.orders;
       const q = f.search.toLowerCase();
       return adminState.orders.filter(o => {
          // Text Search (all fields including Creado Por)
          if (q && !(
             o.nombre.toLowerCase().includes(q) ||
             o.email.toLowerCase().includes(q) ||
             o.resumen.toLowerCase().includes(q) ||
             (o.creado_por && o.creado_por.toLowerCase().includes(q))
          )) return false;

          // Date Range Match
          if (f.dateStart && o.date < f.dateStart) return false;
          if (f.dateEnd && o.date > f.dateEnd) return false;

          // Status Match
          if (f.status && o.estado !== f.status) return false;

          return true;
       });
    });

    // Orden de categor칤as para mostrar (puedes ajustar el orden aqu칤)
    const categoryOrder = ['Arroces', 'Granos', 'Carnes', 'Ensaladas', 'Viveres', 'Vegetariana', 'Caldo', 'Opcion_Rapida'];
    const categories = computed(() => {
      if (!menu.value) return [];
      const cats = Object.keys(menu.value);
      // Ordenar seg칰n la lista predefinida, los que no est칠n van al final
      return cats.sort((a, b) => {
        const idxA = categoryOrder.indexOf(a);
        const idxB = categoryOrder.indexOf(b);
        return (idxA === -1 ? 999 : idxA) - (idxB === -1 ? 999 : idxB);
      });
    });

    const selectedCount = computed(() => selection.size);

    // === SUMMARY TABLE HELPERS ===
    const summaryHeaders = computed(() => categoryOrder);

    const userWeeklySummary = computed(() => {
      if (!dates.value.length) return [];

      return dates.value.map(d => {
        const order = allOrders.value[d.value];
        const row = { date: d.value, label: d.label, items: {} };

        if (order && order.detalle) {
          const det = order.detalle;
          // det.categorias and det.items are parallel arrays
          if (Array.isArray(det.categorias) && Array.isArray(det.items)) {
             det.categorias.forEach((cat, idx) => {
                if (!row.items[cat]) {
                   row.items[cat] = det.items[idx];
                } else {
                   // Append if multiple (e.g. Vegetariana)
                   row.items[cat] += ', ' + det.items[idx];
                }
             });
          }
        }
        return row;
      });
    });

    const displayDate = computed(() => {
      const d = dates.value.find(x => x.value === currentDate.value);
      return d ? d.label : currentDate.value;
    });

    const isCutoffPassed = computed(() => {
      if (!currentDate.value) return true;
      if (dates.value.length === 0) return true;
      return !dates.value.some(d => d.value === currentDate.value);
    });

    // === REGLAS DE NEGOCIO (VALIDACIONES) ===
    const specialCats = ['Vegetariana', 'Caldo', 'Opcion_Rapida'];
    // exclusionCats: Categor칤as que no pueden mezclarse entre s칤
    // Nota: En el requerimiento original Arroces no va con V칤veres.

    // Helper: Array de categor칤as seleccionadas actualmente
    const selectedCats = computed(() => {
      const cats = new Set();
      selection.forEach(id => {
        if(selectionData[id]) cats.add(selectionData[id].cat);
      });
      return Array.from(cats);
    });

    const isSpecialSelected = computed(() => {
      return selectedCats.value.some(c => specialCats.includes(c));
    });

    // Validar si una categor칤a entera debe bloquearse (gris)
    const isCatDisabled = (cat) => {
      // 1. Si eleg칤 un especial, bloqueo todo lo que NO sea esa misma categor칤a especial
      if (isSpecialSelected.value) {
        if (selectedCats.value.includes(cat)) return false;
        return true;
      }

      // 2. Regla Granos (Estricta)
      if (selectedCats.value.includes('Granos')) {
        const allowed = ['Granos', 'Arroces', 'Carnes', 'Ensaladas', 'Caldo'];
        if (!allowed.includes(cat)) return true;
      }

      if (cat === 'Granos') {
         if (selectedCats.value.some(c => ['Viveres', 'Vegetariana', 'Opcion_Rapida'].includes(c))) return true;
         let hasNonWhiteRice = false;
         selection.forEach(id => {
            const item = selectionData[id];
            if (item && item.cat === 'Arroces' && !item.plato.toLowerCase().includes('arroz blanco')) hasNonWhiteRice = true;
         });
         if (hasNonWhiteRice) return true;
      }

      // 3. Regla Arroz vs Viveres (Mutuamente exclusivos)
      if (cat === 'Arroces' && selectedCats.value.includes('Viveres')) return true;
      if (cat === 'Viveres' && selectedCats.value.includes('Arroces')) return true;

      // 4. Si eleg칤 algo "Regular" (Arroz, Carne, etc.), bloqueo los "Especiales"
      if (selectedCount.value > 0 && specialCats.includes(cat)) return true;

      return false;
    };

    // Validar items espec칤ficos
    const isItemDisabled = (cat, item) => {
       if (isCatDisabled(cat)) return true;
       // Si Granos est치 seleccionado, y estamos en Arroces, solo Arroz Blanco est치 permitido.
       if (cat === 'Arroces' && selectedCats.value.includes('Granos')) {
          if (!item.plato.toLowerCase().includes('arroz blanco')) return true;
       }
       return false;
    };

    // Warnings espec칤ficos
    const showGrainWarning = computed(() => {
      // Si seleccion칩 Granos
      if (!selectedCats.value.includes('Granos')) return false;

      // Verificar si hay alg칰n plato que contenga "Arroz Blanco" (case insensitive)
      let hasWhiteRice = false;
      selection.forEach(id => {
        const item = selectionData[id];
        if (item && item.cat === 'Arroces' && item.plato.toLowerCase().includes('arroz blanco')) {
          hasWhiteRice = true;
        }
      });
      return !hasWhiteRice; // Muestra warning si NO hay arroz blanco
    });

    const validationError = computed(() => {
      if (selectedCount.value === 0) return null;
      if (showGrainWarning.value) return "Debes seleccionar Arroz Blanco para acompa침ar los granos.";
      return null;
    });

    const hasBlockingErrors = computed(() => {
      return selectedCount.value === 0 || validationError.value !== null;
    });

    // === ACCIONES (ACTIONS) ===

    const loadData = (targetDate = null) => {
      loading.value = true;
      // Limpiamos selecci칩n al cambiar de d칤a o recargar
      selection.clear();
      for (const prop of Object.getOwnPropertyNames(selectionData)) {
        delete selectionData[prop];
      }
      comments.value = '';

      google.script.run
        .withSuccessHandler(res => {
          loading.value = false;
          if (res.ok) {
            // Caso: No hay fechas futuras disponibles
            if (res.empty) {
              dates.value = [];
              menu.value = {};
              return;
            }
            // Cargar datos
            user.value = res.user;
            activeUser.value = res.activeUser || {};
            deptUsers.value = res.deptUsers || [];
            menu.value = res.menu;
            myOrder.value = res.myOrder;
            allMenus.value = res.allMenus || {};
            allOrders.value = res.allOrders || {};
            adminData.value = res.adminData;
            remindersEnabled.value = res.userPrefs?.reminders !== false;

            // Map Dept IDs if needed (e.g. for display in Admin)
            if (res.deptMap) adminState.deptMap = res.deptMap;

            if (res.nextBusinessDay) adminState.nextBusinessDay = res.nextBusinessDay;

            bannerConfig.value = res.bannerConfig || { text: '', limit: 5 };
            const bCount = res.userPrefs?.banner_count || 0;
            if (bCount < bannerConfig.value.limit) {
              showMultiDayBanner.value = true;
            }

            // Actualizar estado de fechas
            currentDate.value = res.currentDate;
            dates.value = res.dates;
          } else {
            alert("Error cargando datos: " + res.msg);
          }
        })
        .withFailureHandler(err => {
          loading.value = false;
          alert("Error de conexi칩n con el servidor.");
        })
        .apiGetInitData(targetDate, impersonateEmail.value);
    };

    // Cambiar de fecha (Tabs superiores)
    const changeDate = (dateStr) => {
      if (dateStr === currentDate.value) return;

      if (allMenus.value[dateStr]) {
        currentDate.value = dateStr;
        menu.value = allMenus.value[dateStr];
        myOrder.value = allOrders.value[dateStr] || null;

        selection.clear();
        for (const prop of Object.getOwnPropertyNames(selectionData)) {
          delete selectionData[prop];
        }
        comments.value = '';
      } else {
        loadData(dateStr);
      }
    };

    const toggleItem = (cat, item) => {
      if (isItemDisabled(cat, item) && !selection.has(item.id)) return;

      if (selection.has(item.id)) {
        selection.delete(item.id);
        delete selectionData[item.id];
      } else {
        // Single selection rule
        if (!['Vegetariana', 'Opcion_Rapida'].includes(cat)) {
           const toRemove = [];
           selection.forEach(id => {
              if (selectionData[id] && selectionData[id].cat === cat) toRemove.push(id);
           });
           toRemove.forEach(id => {
              selection.delete(id);
              delete selectionData[id];
           });
        }

        selection.add(item.id);
        selectionData[item.id] = { cat, plato: item.plato };
      }
    };

    const changeProxyUser = () => {
       loadData(currentDate.value);
    };

    const toggleReminders = () => {
      remindersEnabled.value = !remindersEnabled.value;
      google.script.run.apiSetUserPreference('reminders', remindersEnabled.value, isDeptAdmin.value ? impersonateEmail.value : null);
    };

    const toggleAdminView = () => {
       if (viewMode.value === 'USER') {
          viewMode.value = 'ADMIN';
          loadAdminData();
       } else {
          viewMode.value = 'USER';
       }
    };

    const loadAdminData = (force = false) => {
       if (!force && adminState.users.length > 0) return;
       adminState.loading = true;
       google.script.run
         .withSuccessHandler(res => {
            adminState.loading = false;
            if(res.ok) {
               adminState.users = res.users;
               adminState.orders = res.orders;
               adminState.departments = res.departments || [];
               adminState.config = res.config || {};
               adminState.configList = res.configList || [];
               adminState.configKeys = res.configKeys || [];
               adminState.holidays = res.holidays || [];

               try {
                  adminState.responsiblesList = JSON.parse(adminState.config['RESPONSIBLES_EMAILS_JSON'] || '[]');
                  if (!Array.isArray(adminState.responsiblesList)) adminState.responsiblesList = [];
               } catch(e) { adminState.responsiblesList = []; }

               // Also populate dept map from list
               const map = {};
               adminState.departments.forEach(d => map[d.id] = d.nombre);
               adminState.deptMap = map;
            } else {
               alert(res.msg);
            }
         })
         .apiGetAdminData();
    };

    // Admin Actions
    const openUserModal = (u = null) => {
       adminState.userModal.isNew = !u;
       adminState.userModal.data = u ? { ...u } : { email: '', nombre: '', departamento: activeUser.value.departamento || '', rol: 'USUARIO', estado: 'ACTIVO' };
       adminState.userModal.open = true;
    };

    const saveUser = () => {
       if(!adminState.userModal.data.email || !adminState.userModal.data.nombre) return alert("Faltan datos");
       adminState.loading = true;
       google.script.run
         .withSuccessHandler(res => {
            adminState.loading = false;
            if(res.ok) {
               adminState.userModal.open = false;
               loadAdminData(true);
            } else {
               alert(res.msg);
            }
         })
         .apiAdminSaveUser(adminState.userModal.data);
    };

    const toggleUserStatus = (u) => {
       if(!confirm(`${u.estado === 'ACTIVO' ? 'Desactivar' : 'Activar'} a ${u.nombre}?`)) return;
       const newState = u.estado === 'ACTIVO' ? 'INACTIVO' : 'ACTIVO';
       const payload = { ...u, estado: newState };
       adminState.loading = true;
       google.script.run.withSuccessHandler(() => { loadAdminData(true); }).apiAdminSaveUser(payload);
    };

    const adminCancelOrder = (orderId) => {
       if(!confirm("쮺ancelar pedido?")) return;
       adminState.loading = true;
       google.script.run.withSuccessHandler(res => {
          if(res.ok) loadAdminData(true);
          else { alert(res.msg); adminState.loading = false; }
       }).apiAdminCancelOrder(orderId);
    };

    // Department Actions
    const openDeptModal = (d = null) => {
       adminState.deptModal.isNew = !d;
       adminState.deptModal.data = d ? { ...d } : { nombre: '', admins: '', estado: 'ACTIVO' };
       adminState.deptModal.open = true;
    };

    const saveDept = () => {
       if(!adminState.deptModal.data.nombre) return alert("Nombre requerido");
       adminState.loading = true;
       google.script.run.withSuccessHandler(res => {
          adminState.loading = false;
          if(res.ok) { adminState.deptModal.open = false; loadAdminData(true); }
          else alert(res.msg);
       }).apiSaveDepartment(adminState.deptModal.data);
    };

    const deleteDept = (id) => {
       if(!confirm("쮼liminar departamento?")) return;
       google.script.run.withSuccessHandler(res => { if(res.ok) loadAdminData(true); else alert(res.msg); }).apiDeleteDepartment(id);
    };

    // Config Actions
    const saveConfig = () => {
       adminState.config['RESPONSIBLES_EMAILS_JSON'] = JSON.stringify(adminState.responsiblesList);
       adminState.loading = true;
       google.script.run.withSuccessHandler(res => {
          adminState.loading = false;
          if(res.ok) { adminState.configEdit = false; loadAdminData(true); }
          else alert(res.msg);
       }).apiSaveConfig(adminState.config);
    };

    // Menu Actions
    const checkMenuDate = () => {
       if (!adminState.menuDate) return;
       const d = new Date(adminState.menuDate + 'T12:00:00');
       const day = d.getDay();
       const now = new Date();
       now.setHours(0,0,0,0);
       const dZero = new Date(d);
       dZero.setHours(0,0,0,0);

       if (day === 0 || day === 6) {
          alert("No se puede editar fines de semana.");
          adminState.menuDate = '';
          return;
       }
       if (dZero < now) { // Strict future? User said "fechas pasadas". Today might be allowed if open?
          // User said "si ya pasan de la hora de cierre... deja de ser h치bil".
          // If I edit *today* after cut-off, it should be blocked.
          // Frontend doesn't know cutoff easily without logic.
          // But backend `apiGetMenuDay` will fail if strict.
          // Frontend check: just past days.
          alert("Solo se pueden editar fechas futuras o el d칤a actual v치lido.");
          adminState.menuDate = '';
          return;
       }
       // If past, block.
       if (dZero < now) {
          alert("No se pueden editar fechas pasadas.");
          adminState.menuDate = '';
          return;
       }

       loadMenuDay();
    };

    const loadMenuDay = () => {
       if(!adminState.menuDate) return;
       adminState.loading = true;
       google.script.run
         .withSuccessHandler(res => {
            adminState.loading = false;
            if(res.ok) adminState.menuItems = res.items;
            else {
               alert(res.msg);
               adminState.menuDate = '';
               adminState.menuItems = [];
            }
         })
         .withFailureHandler(err => {
            adminState.loading = false;
            alert(err.message);
            adminState.menuDate = '';
            adminState.menuItems = [];
         })
         .apiGetMenuDay(adminState.menuDate);
    };

    const openMenuModal = (item = null, cat = 'Arroces') => {
       adminState.menuModal.isNew = !item;
       adminState.menuModal.data = item ? {...item} : { cat, plato: '', desc: '' };
       adminState.menuModal.open = true;
    };

    const saveMenuItem = () => {
       if(!adminState.menuModal.data.plato) return alert("Nombre requerido");
       adminState.loading = true;
       google.script.run
         .withSuccessHandler(res => {
            adminState.loading = false;
            if(res.ok) { adminState.menuModal.open = false; loadMenuDay(); }
            else alert(res.msg);
         })
         .withFailureHandler(err => {
            adminState.loading = false;
            alert(err.message);
         })
         .apiSaveMenuItem(adminState.menuDate, adminState.menuModal.data.cat, adminState.menuModal.data);
    };

    const deleteMenuItem = (id) => {
       if(!confirm("쮼liminar plato?")) return;
       adminState.loading = true;
       google.script.run.withSuccessHandler(res => {
          adminState.loading = false;
          if(res.ok) loadMenuDay();
          else alert(res.msg);
       }).apiDeleteMenuItem(id);
    };

    // Holiday Actions
    const saveHoliday = () => {
       if(!adminState.holidayModal.data.date) return alert("Fecha requerida");
       adminState.loading = true;
       google.script.run
         .withSuccessHandler(res => {
            adminState.loading = false;
            if(res.ok) {
               adminState.holidayModal.open = false;
               adminState.holidays.push({ date: adminState.holidayModal.data.date, desc: adminState.holidayModal.data.desc });
               loadData(); // Refresh user view
            }
            else alert(res.msg);
         })
         .withFailureHandler(err => {
            adminState.loading = false;
            alert("Error: " + err.message);
         })
         .apiSaveHoliday(adminState.holidayModal.data.date, adminState.holidayModal.data.desc);
    };

    const deleteHoliday = (date) => {
       if(!confirm("쮼liminar d칤a libre?")) return;
       adminState.loading = true;
       google.script.run.withSuccessHandler(res => {
           adminState.loading = false;
           if(res.ok) {
              adminState.holidays = adminState.holidays.filter(h => h.date !== date);
              loadData();
           }
       }).apiDeleteHoliday(date);
    };

    const clearFilters = (type) => {
       if(type === 'orders') {
          adminState.filters.orders = { search: '', dateStart: '', dateEnd: '', status: '', open: true };
       } else {
          adminState.filters.users.search = '';
       }
    };

    const addResponsible = () => {
       adminState.responsiblesList.push({ name: '', email: '', type: 'CC' });
    };

    const removeResponsible = (idx) => {
       adminState.responsiblesList.splice(idx, 1);
    };

    const addDeptAdmin = (user) => {
       if (user.rol === 'ADMIN_GEN') return alert("No se puede asignar un Admin General como Admin de Departamento.");
       if (user.rol === 'ADMIN_DEP') {
          if (!confirm(`Advertencia: ${user.nombre} dejar치 de ser admin de su departamento actual.`)) return;
       }
       let current = adminState.deptModal.data.admins ? adminState.deptModal.data.admins.split(',').map(e=>e.trim()).filter(e=>e) : [];
       if (!current.includes(user.email)) {
          current.push(user.email);
          adminState.deptModal.data.admins = current.join(', ');
       }
    };

    const removeDeptAdmin = (email) => {
       let current = adminState.deptModal.data.admins ? adminState.deptModal.data.admins.split(',').map(e=>e.trim()).filter(e=>e) : [];
       current = current.filter(e => e !== email);
       adminState.deptModal.data.admins = current.join(', ');
    };

    const dismissBanner = () => {
      showMultiDayBanner.value = false;
      google.script.run.apiDismissBanner();
    };

    const submitOrder = () => {
      if (hasBlockingErrors.value) return;

      submitting.value = true;

      // Preparamos el objeto para enviar
      const payload = {
        date: currentDate.value,
        impersonateEmail: impersonateEmail.value,
        categorias: Array.from(selection).map(id => selectionData[id].cat),
        items: Array.from(selection).map(id => selectionData[id].plato),
        detalleIds: Array.from(selection),
        comentarios: comments.value
      };

      google.script.run
        .withSuccessHandler(res => {
          submitting.value = false;
          if (res.ok) {
            // Recargar la misma fecha para ver la confirmaci칩n
            loadData(currentDate.value);
          } else {
            alert("Error: " + res.msg);
          }
        })
        .withFailureHandler(() => {
          submitting.value = false;
          alert("Error enviando el pedido. Intenta nuevamente.");
        })
        .apiSubmitOrder(payload);
    };

    const cancelOrder = () => {
      if (!myOrder.value) return;
      if (!confirm("쮼st치s seguro de cancelar este pedido?")) return;

      loading.value = true;
      google.script.run
        .withSuccessHandler(res => {
           if (res.ok) {
             // Al cancelar, recargamos datos de la fecha actual
             loadData(currentDate.value);
           } else {
             alert(res.msg);
             loading.value = false;
           }
        })
        .withFailureHandler(() => {
          loading.value = false;
          alert("Error al cancelar.");
        })
        .apiCancelOrder(myOrder.value.id);
    };

    // UI Helpers
    const formatCatName = (c) => c.replace(/_/g, ' ');

    const hasSelectionInCat = (cat) => selectedCats.value.includes(cat);

    const isSelected = (id) => selection.has(id);

    const scrollToCat = (cat) => {
      const el = document.getElementById('cat-'+cat);
      if(el) {
        // Offset for sticky header
        const y = el.getBoundingClientRect().top + window.pageYOffset - 140;
        window.scrollTo({top: y, behavior: 'smooth'});
      }
    };

    const getIconForCategory = (cat) => {
      const map = {
        'Arroces': 'fa-bowl-rice',
        'Granos': 'fa-spoon', // Generic
        'Carnes': 'fa-drumstick-bite',
        'Ensaladas': 'fa-carrot',
        'Viveres': 'fa-utensils',
        'Vegetariana': 'fa-leaf',
        'Caldo': 'fa-mug-hot',
        'Opcion_Rapida': 'fa-burger'
      };
      return 'fa-solid ' + (map[cat] || 'fa-circle');
    };

    // Inicializaci칩n
    onMounted(() => {
      loadData(); // Carga inicial sin fecha (el servidor decide la primera disponible)
    });

    return {
      // Estado
      loading, submitting, user, menu, myOrder, adminData,
      currentDate, dates, comments,

      // Computed
      isAdmin, isDeptAdmin, isAdminGen, menuLoaded, categories,
      selectedCount, validationError, hasBlockingErrors, showGrainWarning,
      displayDate, isCutoffPassed,

      // M칠todos / Reglas UI
      toggleItem, isSelected, hasSelectionInCat, isCatDisabled, isItemDisabled,

      // Estado
      remindersEnabled, showMultiDayBanner, bannerConfig,
      activeUser, deptUsers, impersonateEmail,
      viewMode, adminState,

      // Acciones Principales
      changeDate, submitOrder, cancelOrder, toggleReminders, dismissBanner, changeProxyUser,
      toggleAdminView, loadAdminData,

      // Admin Actions
      openUserModal, saveUser, toggleUserStatus, adminCancelOrder,
      openDeptModal, saveDept, deleteDept, saveConfig, clearFilters,

      // Dept Helpers
      addDeptAdmin, removeDeptAdmin, deptAdminSearch, filteredAdminUsers, deptMoveHint,

      // Menu/Holiday
      checkMenuDate, loadMenuDay, openMenuModal, saveMenuItem, deleteMenuItem,
      saveHoliday, deleteHoliday,

      // Filtered Data
      filteredUsers, filteredOrders,

      // UI Utils
      formatCatName, scrollToCat, getIconForCategory,

      // Summary
      userWeeklySummary, summaryHeaders
    };
  }
}).mount('#app');
</script>
</body>
</html>