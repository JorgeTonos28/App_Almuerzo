<script>
const { createApp, ref, computed, onMounted, reactive } = Vue;

createApp({
  setup() {
    // === ESTADO (STATE) ===
    const loading = ref(true);
    const submitting = ref(false);
    
    // Datos del usuario y app
    const user = ref({});
    const activeUser = ref({});
    const deptUsers = ref([]);
    const impersonateEmail = ref('');
    const menu = ref({});
    const myOrder = ref(null);
    const adminData = ref(null);
    
    // Manejo de Fechas (Nuevo)
    const currentDate = ref(''); // Fecha seleccionada actualmente (YYYY-MM-DD)
    const dates = ref([]);       // Lista de fechas disponibles (tabs)
    const allMenus = ref({});
    const allOrders = ref({});
    const remindersEnabled = ref(true);
    const showMultiDayBanner = ref(false);
    const bannerConfig = ref({ text: '', limit: 5 });
    
    // Formulario
    const comments = ref('');
    const selection = reactive(new Set());
    const selectionData = reactive({});

    // ADMIN STATE
    const viewMode = ref('USER'); // USER | ADMIN
    const adminState = reactive({
       loading: false,
       tab: 'USUARIOS',
       users: [],
       orders: [],
       departments: [],
       deptMap: {}, // ID -> Name
       config: {},
       configKeys: [],
       holidays: [],
       userModal: { open: false, isNew: true, data: {} },
       deptModal: { open: false, isNew: true, data: {} },
       configEdit: false,
       filters: {
          orders: { search: '', dateStart: '', dateEnd: '', status: '', open: false },
          users: { search: '' }
       },
       // Menu Editor
       menuDate: '',
       menuItems: [],
       menuModal: { open: false, isNew: true, data: {} },
       // Holiday Editor
       holidayModal: { open: false, data: {} }
    });

    // === COMPUTED PROPERTIES ===
    const isAdmin = computed(() => activeUser.value.rol && ['ADMIN_GEN', 'ADMIN_DEP'].includes(activeUser.value.rol));
    const isDeptAdmin = computed(() => activeUser.value.rol === 'ADMIN_DEP');
    const isAdminGen = computed(() => activeUser.value.rol === 'ADMIN_GEN');
    
    const menuLoaded = computed(() => menu.value && Object.keys(menu.value).length > 0);

    // FILTERED LISTS
    const filteredUsers = computed(() => {
       const q = adminState.filters.users.search.toLowerCase();
       if (!q) return adminState.users;
       return adminState.users.filter(u =>
          u.nombre.toLowerCase().includes(q) ||
          u.email.toLowerCase().includes(q) ||
          u.departamento.toLowerCase().includes(q)
       );
    });

    const filteredOrders = computed(() => {
       const f = adminState.filters.orders;
       const q = f.search.toLowerCase();
       return adminState.orders.filter(o => {
          // Text Search (all fields including Creado Por)
          if (q && !(
             o.nombre.toLowerCase().includes(q) ||
             o.email.toLowerCase().includes(q) ||
             o.resumen.toLowerCase().includes(q) ||
             (o.creado_por && o.creado_por.toLowerCase().includes(q))
          )) return false;

          // Date Range Match
          if (f.dateStart && o.date < f.dateStart) return false;
          if (f.dateEnd && o.date > f.dateEnd) return false;

          // Status Match
          if (f.status && o.estado !== f.status) return false;

          return true;
       });
    });
    
    // Orden de categorías para mostrar (puedes ajustar el orden aquí)
    const categoryOrder = ['Arroces', 'Granos', 'Carnes', 'Ensaladas', 'Viveres', 'Vegetariana', 'Caldo', 'Opcion_Rapida'];
    const categories = computed(() => {
      if (!menu.value) return [];
      const cats = Object.keys(menu.value);
      // Ordenar según la lista predefinida, los que no estén van al final
      return cats.sort((a, b) => {
        const idxA = categoryOrder.indexOf(a);
        const idxB = categoryOrder.indexOf(b);
        return (idxA === -1 ? 999 : idxA) - (idxB === -1 ? 999 : idxB);
      });
    });
    
    const selectedCount = computed(() => selection.size);

    // === SUMMARY TABLE HELPERS ===
    const summaryHeaders = computed(() => categoryOrder);

    const userWeeklySummary = computed(() => {
      if (!dates.value.length) return [];

      return dates.value.map(d => {
        const order = allOrders.value[d.value];
        const row = { date: d.value, label: d.label, items: {} };

        if (order && order.detalle) {
          const det = order.detalle;
          // det.categorias and det.items are parallel arrays
          if (Array.isArray(det.categorias) && Array.isArray(det.items)) {
             det.categorias.forEach((cat, idx) => {
                if (!row.items[cat]) {
                   row.items[cat] = det.items[idx];
                } else {
                   // Append if multiple (e.g. Vegetariana)
                   row.items[cat] += ', ' + det.items[idx];
                }
             });
          }
        }
        return row;
      });
    });

    const displayDate = computed(() => {
      const d = dates.value.find(x => x.value === currentDate.value);
      return d ? d.label : currentDate.value;
    });

    const isCutoffPassed = computed(() => {
      if (!currentDate.value) return true;
      if (dates.value.length === 0) return true;
      return !dates.value.some(d => d.value === currentDate.value);
    });

    // === REGLAS DE NEGOCIO (VALIDACIONES) ===
    const specialCats = ['Vegetariana', 'Caldo', 'Opcion_Rapida'];
    // exclusionCats: Categorías que no pueden mezclarse entre sí
    // Nota: En el requerimiento original Arroces no va con Víveres.
    
    // Helper: Array de categorías seleccionadas actualmente
    const selectedCats = computed(() => {
      const cats = new Set();
      selection.forEach(id => {
        if(selectionData[id]) cats.add(selectionData[id].cat);
      });
      return Array.from(cats);
    });

    const isSpecialSelected = computed(() => {
      return selectedCats.value.some(c => specialCats.includes(c));
    });

    // Validar si una categoría entera debe bloquearse (gris)
    const isCatDisabled = (cat) => {
      // 1. Si elegí un especial, bloqueo todo lo que NO sea esa misma categoría especial
      if (isSpecialSelected.value) {
        if (selectedCats.value.includes(cat)) return false;
        return true;
      }

      // 2. Regla Granos (Estricta)
      if (selectedCats.value.includes('Granos')) {
        const allowed = ['Granos', 'Arroces', 'Carnes', 'Ensaladas', 'Caldo'];
        if (!allowed.includes(cat)) return true;
      }

      if (cat === 'Granos') {
         if (selectedCats.value.some(c => ['Viveres', 'Vegetariana', 'Opcion_Rapida'].includes(c))) return true;
         let hasNonWhiteRice = false;
         selection.forEach(id => {
            const item = selectionData[id];
            if (item && item.cat === 'Arroces' && !item.plato.toLowerCase().includes('arroz blanco')) hasNonWhiteRice = true;
         });
         if (hasNonWhiteRice) return true;
      }

      // 3. Regla Arroz vs Viveres (Mutuamente exclusivos)
      if (cat === 'Arroces' && selectedCats.value.includes('Viveres')) return true;
      if (cat === 'Viveres' && selectedCats.value.includes('Arroces')) return true;

      // 4. Si elegí algo "Regular" (Arroz, Carne, etc.), bloqueo los "Especiales"
      if (selectedCount.value > 0 && specialCats.includes(cat)) return true;

      return false;
    };

    // Validar items específicos
    const isItemDisabled = (cat, item) => {
       if (isCatDisabled(cat)) return true;
       // Si Granos está seleccionado, y estamos en Arroces, solo Arroz Blanco está permitido.
       if (cat === 'Arroces' && selectedCats.value.includes('Granos')) {
          if (!item.plato.toLowerCase().includes('arroz blanco')) return true;
       }
       return false;
    };

    // Warnings específicos
    const showGrainWarning = computed(() => {
      // Si seleccionó Granos
      if (!selectedCats.value.includes('Granos')) return false;
      
      // Verificar si hay algún plato que contenga "Arroz Blanco" (case insensitive)
      let hasWhiteRice = false;
      selection.forEach(id => {
        const item = selectionData[id];
        if (item && item.cat === 'Arroces' && item.plato.toLowerCase().includes('arroz blanco')) {
          hasWhiteRice = true;
        }
      });
      return !hasWhiteRice; // Muestra warning si NO hay arroz blanco
    });

    const validationError = computed(() => {
      if (selectedCount.value === 0) return null;
      if (showGrainWarning.value) return "Debes seleccionar Arroz Blanco para acompañar los granos.";
      return null;
    });

    const hasBlockingErrors = computed(() => {
      return selectedCount.value === 0 || validationError.value !== null;
    });

    // === ACCIONES (ACTIONS) ===

    const loadData = (targetDate = null) => {
      loading.value = true;
      // Limpiamos selección al cambiar de día o recargar
      selection.clear();
      for (const prop of Object.getOwnPropertyNames(selectionData)) {
        delete selectionData[prop];
      }
      comments.value = '';

      google.script.run
        .withSuccessHandler(res => {
          loading.value = false;
          if (res.ok) {
            // Caso: No hay fechas futuras disponibles
            if (res.empty) {
              dates.value = [];
              menu.value = {};
              return;
            }
            // Cargar datos
            user.value = res.user;
            activeUser.value = res.activeUser || {};
            deptUsers.value = res.deptUsers || [];
            menu.value = res.menu;
            myOrder.value = res.myOrder;
            allMenus.value = res.allMenus || {};
            allOrders.value = res.allOrders || {};
            adminData.value = res.adminData;
            remindersEnabled.value = res.userPrefs?.reminders !== false;

            // Map Dept IDs if needed (e.g. for display in Admin)
            if (res.deptMap) adminState.deptMap = res.deptMap;

            bannerConfig.value = res.bannerConfig || { text: '', limit: 5 };
            const bCount = res.userPrefs?.banner_count || 0;
            if (bCount < bannerConfig.value.limit) {
              showMultiDayBanner.value = true;
            }
            
            // Actualizar estado de fechas
            currentDate.value = res.currentDate;
            dates.value = res.dates;
          } else {
            alert("Error cargando datos: " + res.msg);
          }
        })
        .withFailureHandler(err => {
          loading.value = false;
          alert("Error de conexión con el servidor.");
        })
        .apiGetInitData(targetDate, impersonateEmail.value);
    };

    // Cambiar de fecha (Tabs superiores)
    const changeDate = (dateStr) => {
      if (dateStr === currentDate.value) return;

      if (allMenus.value[dateStr]) {
        currentDate.value = dateStr;
        menu.value = allMenus.value[dateStr];
        myOrder.value = allOrders.value[dateStr] || null;

        selection.clear();
        for (const prop of Object.getOwnPropertyNames(selectionData)) {
          delete selectionData[prop];
        }
        comments.value = '';
      } else {
        loadData(dateStr);
      }
    };

    const toggleItem = (cat, item) => {
      if (isItemDisabled(cat, item) && !selection.has(item.id)) return;

      if (selection.has(item.id)) {
        selection.delete(item.id);
        delete selectionData[item.id];
      } else {
        // Single selection rule
        if (!['Vegetariana', 'Opcion_Rapida'].includes(cat)) {
           const toRemove = [];
           selection.forEach(id => {
              if (selectionData[id] && selectionData[id].cat === cat) toRemove.push(id);
           });
           toRemove.forEach(id => {
              selection.delete(id);
              delete selectionData[id];
           });
        }

        selection.add(item.id);
        selectionData[item.id] = { cat, plato: item.plato };
      }
    };

    const changeProxyUser = () => {
       loadData(currentDate.value);
    };

    const toggleReminders = () => {
      remindersEnabled.value = !remindersEnabled.value;
      google.script.run.apiSetUserPreference('reminders', remindersEnabled.value, isDeptAdmin.value ? impersonateEmail.value : null);
    };

    const toggleAdminView = () => {
       if (viewMode.value === 'USER') {
          viewMode.value = 'ADMIN';
          loadAdminData();
       } else {
          viewMode.value = 'USER';
       }
    };

    const loadAdminData = () => {
       adminState.loading = true;
       google.script.run
         .withSuccessHandler(res => {
            adminState.loading = false;
            if(res.ok) {
               adminState.users = res.users;
               adminState.orders = res.orders;
               adminState.departments = res.departments || [];
               adminState.config = res.config || {};
               adminState.configKeys = res.configKeys || [];
               adminState.holidays = res.holidays || [];
               // Also populate dept map from list
               const map = {};
               adminState.departments.forEach(d => map[d.id] = d.nombre);
               adminState.deptMap = map;
            } else {
               alert(res.msg);
            }
         })
         .apiGetAdminData();
    };

    // Admin Actions
    const openUserModal = (u = null) => {
       adminState.userModal.isNew = !u;
       adminState.userModal.data = u ? { ...u } : { email: '', nombre: '', departamento: activeUser.value.departamento || '', rol: 'USUARIO', estado: 'ACTIVO' };
       adminState.userModal.open = true;
    };

    const saveUser = () => {
       if(!adminState.userModal.data.email || !adminState.userModal.data.nombre) return alert("Faltan datos");
       adminState.loading = true;
       google.script.run
         .withSuccessHandler(res => {
            adminState.loading = false;
            if(res.ok) {
               adminState.userModal.open = false;
               loadAdminData();
            } else {
               alert(res.msg);
            }
         })
         .apiAdminSaveUser(adminState.userModal.data);
    };

    const toggleUserStatus = (u) => {
       if(!confirm(`¿${u.estado === 'ACTIVO' ? 'Desactivar' : 'Activar'} a ${u.nombre}?`)) return;
       const newState = u.estado === 'ACTIVO' ? 'INACTIVO' : 'ACTIVO';
       // We can reuse saveUser logic or create a dedicated endpoint.
       // For simplicity, we use apiAdminSaveUser updating just status if the backend supports it,
       // or we manually constructing the object.
       const payload = { ...u, estado: newState };
       adminState.loading = true;
       google.script.run.withSuccessHandler(() => { loadAdminData(); }).apiAdminSaveUser(payload);
    };

    const adminCancelOrder = (orderId) => {
       if(!confirm("¿Cancelar pedido?")) return;
       adminState.loading = true;
       google.script.run.withSuccessHandler(res => {
          if(res.ok) loadAdminData();
          else { alert(res.msg); adminState.loading = false; }
       }).apiAdminCancelOrder(orderId);
    };

    // Department Actions
    const openDeptModal = (d = null) => {
       adminState.deptModal.isNew = !d;
       adminState.deptModal.data = d ? { ...d } : { nombre: '', admins: '', estado: 'ACTIVO' };
       adminState.deptModal.open = true;
    };

    const saveDept = () => {
       if(!adminState.deptModal.data.nombre) return alert("Nombre requerido");
       adminState.loading = true;
       google.script.run.withSuccessHandler(res => {
          adminState.loading = false;
          if(res.ok) { adminState.deptModal.open = false; loadAdminData(); }
          else alert(res.msg);
       }).apiSaveDepartment(adminState.deptModal.data);
    };

    const deleteDept = (id) => {
       if(!confirm("¿Eliminar departamento?")) return;
       google.script.run.withSuccessHandler(res => { if(res.ok) loadAdminData(); else alert(res.msg); }).apiDeleteDepartment(id);
    };

    // Config Actions
    const saveConfig = () => {
       adminState.loading = true;
       google.script.run.withSuccessHandler(res => {
          adminState.loading = false;
          if(res.ok) { adminState.configEdit = false; loadAdminData(); }
          else alert(res.msg);
       }).apiSaveConfig(adminState.config);
    };

    // Menu Actions
    const loadMenuDay = () => {
       if(!adminState.menuDate) return;
       adminState.loading = true;
       google.script.run.withSuccessHandler(res => {
          adminState.loading = false;
          if(res.ok) adminState.menuItems = res.items;
          else alert(res.msg);
       }).apiGetMenuDay(adminState.menuDate);
    };

    const openMenuModal = (item = null, cat = 'Arroces') => {
       adminState.menuModal.isNew = !item;
       adminState.menuModal.data = item ? {...item} : { cat, plato: '', desc: '' };
       adminState.menuModal.open = true;
    };

    const saveMenuItem = () => {
       if(!adminState.menuModal.data.plato) return alert("Nombre requerido");
       adminState.loading = true;
       google.script.run.withSuccessHandler(res => {
          adminState.loading = false;
          if(res.ok) { adminState.menuModal.open = false; loadMenuDay(); }
          else alert(res.msg);
       }).apiSaveMenuItem(adminState.menuDate, adminState.menuModal.data.cat, adminState.menuModal.data);
    };

    const deleteMenuItem = (id) => {
       if(!confirm("¿Eliminar plato?")) return;
       adminState.loading = true;
       google.script.run.withSuccessHandler(res => {
          adminState.loading = false;
          if(res.ok) loadMenuDay();
          else alert(res.msg);
       }).apiDeleteMenuItem(id);
    };

    // Holiday Actions
    const saveHoliday = () => {
       if(!adminState.holidayModal.data.date) return alert("Fecha requerida");
       adminState.loading = true;
       google.script.run.withSuccessHandler(res => {
          adminState.loading = false;
          if(res.ok) { adminState.holidayModal.open = false; loadAdminData(); }
          else alert(res.msg);
       }).apiSaveHoliday(adminState.holidayModal.data.date, adminState.holidayModal.data.desc);
    };

    const deleteHoliday = (date) => {
       if(!confirm("¿Eliminar día libre?")) return;
       adminState.loading = true;
       google.script.run.withSuccessHandler(res => {
           adminState.loading = false;
           if(res.ok) loadAdminData();
       }).apiDeleteHoliday(date);
    };

    const clearFilters = (type) => {
       if(type === 'orders') {
          adminState.filters.orders = { search: '', dateStart: '', dateEnd: '', status: '', open: true };
       } else {
          adminState.filters.users.search = '';
       }
    };

    const responsiblesJson = computed({
        get: () => {
            try { return JSON.parse(adminState.config['RESPONSIBLES_EMAILS_JSON'] || '{}'); }
            catch(e) { return {}; }
        },
        set: (val) => {
            adminState.config['RESPONSIBLES_EMAILS_JSON'] = JSON.stringify(val);
        }
    });

    const dismissBanner = () => {
      showMultiDayBanner.value = false;
      google.script.run.apiDismissBanner();
    };

    const submitOrder = () => {
      if (hasBlockingErrors.value) return;
      
      submitting.value = true;
      
      // Preparamos el objeto para enviar
      const payload = {
        date: currentDate.value,
        impersonateEmail: impersonateEmail.value,
        categorias: Array.from(selection).map(id => selectionData[id].cat),
        items: Array.from(selection).map(id => selectionData[id].plato),
        detalleIds: Array.from(selection),
        comentarios: comments.value
      };

      google.script.run
        .withSuccessHandler(res => {
          submitting.value = false;
          if (res.ok) {
            // Recargar la misma fecha para ver la confirmación
            loadData(currentDate.value); 
          } else {
            alert("Error: " + res.msg);
          }
        })
        .withFailureHandler(() => {
          submitting.value = false;
          alert("Error enviando el pedido. Intenta nuevamente.");
        })
        .apiSubmitOrder(payload);
    };

    const cancelOrder = () => {
      if (!myOrder.value) return;
      if (!confirm("¿Estás seguro de cancelar este pedido?")) return;
      
      loading.value = true;
      google.script.run
        .withSuccessHandler(res => {
           if (res.ok) {
             // Al cancelar, recargamos datos de la fecha actual
             loadData(currentDate.value);
           } else {
             alert(res.msg);
             loading.value = false;
           }
        })
        .withFailureHandler(() => {
          loading.value = false;
          alert("Error al cancelar.");
        })
        .apiCancelOrder(myOrder.value.id);
    };

    // UI Helpers
    const formatCatName = (c) => c.replace(/_/g, ' ');
    
    const hasSelectionInCat = (cat) => selectedCats.value.includes(cat);
    
    const isSelected = (id) => selection.has(id);
    
    const scrollToCat = (cat) => {
      const el = document.getElementById('cat-'+cat);
      if(el) {
        // Offset for sticky header
        const y = el.getBoundingClientRect().top + window.pageYOffset - 140;
        window.scrollTo({top: y, behavior: 'smooth'});
      }
    };

    const getIconForCategory = (cat) => {
      const map = {
        'Arroces': 'fa-bowl-rice',
        'Granos': 'fa-spoon', // Generic
        'Carnes': 'fa-drumstick-bite',
        'Ensaladas': 'fa-carrot',
        'Viveres': 'fa-utensils',
        'Vegetariana': 'fa-leaf',
        'Caldo': 'fa-mug-hot',
        'Opcion_Rapida': 'fa-burger'
      };
      return 'fa-solid ' + (map[cat] || 'fa-circle');
    };

    // Inicialización
    onMounted(() => {
      loadData(); // Carga inicial sin fecha (el servidor decide la primera disponible)
    });

    return {
      // Estado
      loading, submitting, user, menu, myOrder, adminData, 
      currentDate, dates, comments,
      
      // Computed
      isAdmin, isDeptAdmin, isAdminGen, menuLoaded, categories,
      selectedCount, validationError, hasBlockingErrors, showGrainWarning,
      displayDate, isCutoffPassed,
      
      // Métodos / Reglas UI
      toggleItem, isSelected, hasSelectionInCat, isCatDisabled, isItemDisabled,
      
      // Estado
      remindersEnabled, showMultiDayBanner, bannerConfig,
      activeUser, deptUsers, impersonateEmail,
      viewMode, adminState,

      // Acciones Principales
      changeDate, submitOrder, cancelOrder, toggleReminders, dismissBanner, changeProxyUser,
      toggleAdminView, loadAdminData,

      // Admin Actions
      openUserModal, saveUser, toggleUserStatus, adminCancelOrder,
      openDeptModal, saveDept, deleteDept, saveConfig, clearFilters,
      
      // Menu/Holiday
      loadMenuDay, openMenuModal, saveMenuItem, deleteMenuItem,
      saveHoliday, deleteHoliday, responsiblesJson,

      // Filtered Data
      filteredUsers, filteredOrders,

      // UI Utils
      formatCatName, scrollToCat, getIconForCategory,

      // Summary
      userWeeklySummary, summaryHeaders
    };
  }
}).mount('#app');
</script>