<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>Solicitud Almuerzo</title>
  <script src="https://cdn.tailwindcss.com"></script> <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <?!= include('css'); ?>
</head>
<body class="bg-gray-50 text-gray-800 antialiased selection:bg-blue-100 selection:text-blue-800">
  <div id="app" class="min-h-screen flex flex-col">
    
    <!-- Top Tier Header -->
    <header class="bg-white/80 backdrop-blur-md sticky top-0 z-50 border-b border-gray-200/50 supports-[backdrop-filter]:bg-white/60">
      <div class="max-w-4xl mx-auto px-4 h-16 flex items-center justify-between">
        <!-- Brand / Logo -->
        <div class="flex items-center gap-3 group cursor-default">
           <div class="w-10 h-10 bg-gradient-to-br from-blue-600 to-indigo-600 rounded-xl flex items-center justify-center text-white text-lg shadow-lg shadow-blue-500/30 transition-transform group-hover:scale-105">
             <i class="fa-solid fa-utensils"></i>
           </div>
           <div class="flex flex-col">
             <span class="font-bold text-gray-900 leading-none tracking-tight">Almuerzo</span>
             <span class="text-[10px] text-gray-500 font-semibold uppercase tracking-wider mt-0.5">Corporativo</span>
           </div>
        </div>

        <!-- User Actions -->
        <div class="flex items-center gap-4">
           <button @click="toggleReminders"
             :class="['w-9 h-9 rounded-full flex items-center justify-center transition-all focus:outline-none',
               remindersEnabled ? 'bg-blue-50 text-blue-600 hover:bg-blue-100' : 'bg-gray-100 text-gray-400 hover:bg-gray-200']"
             :title="remindersEnabled ? 'Notificaciones activas' : 'Notificaciones desactivadas'">
             <i :class="['fa-solid text-sm', remindersEnabled ? 'fa-bell' : 'fa-bell-slash']"></i>
           </button>

           <div class="flex items-center gap-3 pl-4 border-l border-gray-200">
              <div class="text-right hidden sm:block leading-tight">
                <div class="text-sm font-bold text-gray-900 truncate max-w-[120px]">{{ user.nombre }}</div>
                <div class="text-[10px] text-gray-500 font-medium uppercase tracking-wide">{{ user.departamento }}</div>
              </div>
              <div class="w-9 h-9 bg-gradient-to-br from-gray-100 to-gray-200 text-gray-600 rounded-full flex items-center justify-center font-bold text-sm border-2 border-white shadow-sm ring-1 ring-gray-100">
                 {{ user.nombre ? user.nombre.charAt(0).toUpperCase() : 'U' }}
              </div>
           </div>
        </div>
      </div>
    </header>

    <!-- Loading Overlay -->
    <div v-if="loading" class="fixed inset-0 bg-white/90 backdrop-blur-sm z-[60] flex flex-col items-center justify-center transition-all duration-300">
      <div class="relative">
         <div class="w-16 h-16 border-4 border-blue-100 rounded-full animate-spin border-t-blue-600"></div>
         <i class="fa-solid fa-utensils absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-blue-600 text-xl"></i>
      </div>
      <p class="mt-4 text-sm text-gray-500 font-medium animate-pulse">Preparando menÃº...</p>
    </div>

    <main class="flex-grow max-w-4xl mx-auto w-full p-4 md:p-6 space-y-8">
      
      <!-- Hero Section -->
      <div class="flex justify-between items-end animate-fade-in-up">
        <div>
          <h1 class="text-2xl sm:text-3xl font-bold text-gray-900 tracking-tight">
             Hola, {{ user.nombre ? user.nombre.split(' ')[0] : 'Colaborador' }} <span class="inline-block animate-wave">ðŸ‘‹</span>
          </h1>
          <p class="text-gray-500 font-medium mt-1">Elige tus favoritos para esta semana.</p>
        </div>
      </div>

      <!-- Banner -->
      <div v-if="showMultiDayBanner" class="bg-gradient-to-r from-indigo-600 to-blue-600 rounded-2xl p-5 shadow-lg shadow-blue-500/20 text-white relative overflow-hidden group animate-fade-in">
         <div class="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full blur-2xl -mr-10 -mt-10 pointer-events-none"></div>
         <div class="flex justify-between items-start relative z-10">
           <div class="flex gap-4">
             <div class="w-10 h-10 bg-white/20 backdrop-blur rounded-xl flex items-center justify-center shrink-0">
               <i class="fa-solid fa-calendar-check text-xl"></i>
             </div>
             <div>
               <p class="font-bold text-lg mb-1">Â¡Planifica tu semana!</p>
               <p class="text-blue-100 text-sm leading-relaxed max-w-lg">Ahora puedes adelantar tus pedidos para todos los dÃ­as disponibles. Navega por las pestaÃ±as abajo.</p>
             </div>
           </div>
           <button @click="dismissBanner" class="text-white/60 hover:text-white bg-white/0 hover:bg-white/10 rounded-lg p-2 transition-all">
             <i class="fa-solid fa-xmark text-lg"></i>
           </button>
         </div>
      </div>

      <!-- Weekly Summary Dashboard -->
      <div v-if="userWeeklySummary.length > 0" class="bg-white rounded-3xl shadow-sm border border-gray-100 overflow-hidden animate-fade-in">
        <div class="px-6 py-4 border-b border-gray-50 flex justify-between items-center bg-gray-50/50">
             <h3 class="font-bold text-gray-800 text-sm flex items-center gap-2">
               <span class="w-2 h-2 rounded-full bg-blue-500"></span>
               Mi Resumen Semanal
             </h3>
        </div>
        <div class="overflow-x-auto">
           <div class="max-h-64 overflow-y-auto">
             <table class="w-full text-sm text-left border-collapse">
                <thead class="sticky top-0 bg-white z-10 shadow-sm">
                   <tr>
                      <th class="p-4 whitespace-nowrap text-xs font-bold text-gray-400 uppercase tracking-wider bg-white sticky left-0 z-20">DÃ­a</th>
                      <th v-for="h in summaryHeaders" :key="h" class="p-4 whitespace-nowrap text-xs font-bold text-gray-400 uppercase tracking-wider bg-white">
                        <i :class="getIconForCategory(h) + ' mr-1.5 opacity-50'"></i>{{ formatCatName(h) }}
                      </th>
                   </tr>
                </thead>
                <tbody class="divide-y divide-gray-50">
                   <tr v-for="row in userWeeklySummary" :key="row.date" class="hover:bg-blue-50/30 transition-colors group">
                      <td class="p-4 font-bold text-gray-800 whitespace-nowrap sticky left-0 bg-white group-hover:bg-blue-50/30 transition-colors shadow-[2px_0_5px_-2px_rgba(0,0,0,0.05)] border-r border-gray-50">
                        {{ row.label }}
                      </td>
                      <td v-for="h in summaryHeaders" :key="h" class="p-4 min-w-[140px]">
                         <div v-if="row.items[h]" class="text-xs font-semibold text-blue-700 bg-blue-50 border border-blue-100 px-3 py-1.5 rounded-lg inline-block leading-snug shadow-sm">
                            {{ row.items[h] }}
                         </div>
                         <span v-else class="text-gray-200 text-lg select-none">&middot;</span>
                      </td>
                   </tr>
                </tbody>
             </table>
           </div>
        </div>
      </div>

      <!-- Date Navigation (Tabs) -->
      <div v-if="dates.length > 0" class="border-b border-gray-100 flex gap-8 overflow-x-auto no-scrollbar">
        <button v-for="d in dates" :key="d.value"
          @click="changeDate(d.value)"
          :class="['pb-3 px-1 text-sm font-bold whitespace-nowrap transition-all border-b-2 outline-none',
            currentDate === d.value
            ? 'border-blue-600 text-blue-600'
            : 'border-transparent text-gray-400 hover:text-gray-600 hover:border-gray-200']">
          {{ d.label }}
        </button>
      </div>
      
      <div v-else-if="!loading" class="bg-amber-50 border border-amber-100 p-6 rounded-2xl text-amber-800 text-center flex flex-col items-center gap-3">
        <div class="w-12 h-12 bg-amber-100 rounded-full flex items-center justify-center text-xl">
          <i class="fa-solid fa-clock"></i>
        </div>
        <p class="font-medium">No hay fechas disponibles para ordenar. (Cierre 2:30 PM)</p>
      </div>

      <!-- Order Confirmed State (Receipt Style) -->
      <div v-if="myOrder" class="max-w-md mx-auto bg-white rounded-[2rem] shadow-xl shadow-green-900/5 overflow-hidden text-center relative mt-8 border border-gray-100 animate-fade-in-up">
        <!-- Success Header -->
        <div class="bg-gradient-to-br from-green-400 to-green-600 p-10 text-white relative overflow-hidden">
           <div class="w-24 h-24 bg-white/20 rounded-full absolute -top-10 -right-10 animate-pulse"></div>
           <div class="w-16 h-16 bg-white/10 rounded-full absolute bottom-5 left-5"></div>

           <div class="w-20 h-20 bg-white text-green-500 rounded-full flex items-center justify-center text-3xl mx-auto shadow-lg mb-6 animate-bounce-slow">
              <i class="fa-solid fa-check"></i>
           </div>
           <h2 class="text-2xl font-bold mb-1 tracking-tight">Â¡Pedido Confirmado!</h2>
           <p class="text-green-50 text-sm font-medium opacity-90">Tu almuerzo estÃ¡ asegurado</p>
        </div>

        <!-- Receipt Body -->
        <div class="p-8 relative">
           <!-- Perforation Effect -->
           <div class="absolute top-0 left-0 w-full h-4 -mt-2 z-10 bg-[radial-gradient(circle,transparent_50%,white_50%)] bg-[length:1rem_1rem] rotate-180"></div>

           <div class="space-y-6">
              <div class="flex justify-between items-center text-sm border-b border-gray-100 pb-4 border-dashed">
                 <span class="text-gray-400 font-medium">Fecha de Entrega</span>
                 <span class="font-bold text-gray-800 bg-gray-50 px-3 py-1 rounded-lg">{{ displayDate }}</span>
              </div>
              <div class="text-left">
                 <label class="text-xs text-gray-400 uppercase font-bold tracking-wider mb-2 block">Resumen del pedido</label>
                 <div class="bg-gray-50 p-5 rounded-2xl text-sm text-gray-700 font-medium leading-relaxed border border-gray-100">
                    {{ myOrder.resumen }}
                 </div>
              </div>
           </div>

           <div class="mt-8">
              <button v-if="!isCutoffPassed" @click="cancelOrder" class="w-full py-4 rounded-xl border-2 border-red-50 text-red-500 font-bold hover:bg-red-50 hover:border-red-100 transition-colors text-sm flex items-center justify-center gap-2 group">
                 <i class="fa-solid fa-trash-can opacity-70 group-hover:opacity-100"></i> Cancelar o modificar
              </button>
           </div>
        </div>
      </div>

      <!-- Menu Grid -->
      <div v-else class="animate-fade-in">
        <div v-if="!isCutoffPassed && menuLoaded" class="space-y-8">
          
          <!-- Category Pills (Sticky) -->
          <div class="sticky top-[4.5rem] bg-gray-50/95 backdrop-blur z-40 py-3 -mx-4 px-4 border-b border-gray-200/50 flex gap-3 overflow-x-auto no-scrollbar">
            <button v-for="cat in categories" :key="cat" 
              @click="scrollToCat(cat)"
              :class="['flex items-center gap-2 px-5 py-2.5 rounded-full text-sm font-bold transition-all shadow-sm whitespace-nowrap active:scale-95',
                hasSelectionInCat(cat)
                ? 'bg-gray-900 text-white shadow-md'
                : 'bg-white text-gray-600 border border-gray-200 hover:bg-gray-100 hover:border-gray-300']">
              <i :class="getIconForCategory(cat)"></i> {{ formatCatName(cat) }}
            </button>
          </div>

          <!-- Category Sections -->
          <div v-for="cat in categories" :key="cat" :id="'cat-'+cat" class="scroll-mt-36">
            <h3 class="text-lg font-bold text-gray-900 mb-4 flex items-center">
              {{ formatCatName(cat) }}
              <span v-if="isCatDisabled(cat)" class="ml-3 text-[10px] uppercase font-bold text-red-500 bg-red-50 px-2 py-1 rounded-md tracking-wide">No disponible</span>
            </h3>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div v-for="item in menu[cat]" :key="item.id" 
                   @click="toggleItem(cat, item)"
                   :class="['group relative bg-white p-5 rounded-2xl shadow-sm hover:shadow-md transition-all duration-300 border cursor-pointer flex justify-between gap-4',
                     isSelected(item.id) ? 'ring-2 ring-blue-600 border-transparent bg-blue-50/10' : 'border-gray-100 hover:border-gray-200',
                     isItemDisabled(cat, item) ? 'opacity-50 pointer-events-none grayscale bg-gray-50' : ''
                   ]">
                <div class="flex-grow">
                  <div class="font-bold text-gray-900 text-base mb-1 group-hover:text-blue-700 transition-colors">{{ item.plato }}</div>
                  <div class="text-sm text-gray-500 leading-relaxed">{{ item.desc }}</div>
                </div>
                <div class="flex-shrink-0 pt-1">
                   <div :class="['w-8 h-8 rounded-full flex items-center justify-center transition-all duration-300 transform',
                     isSelected(item.id) ? 'bg-blue-600 text-white scale-110 shadow-lg shadow-blue-500/30' : 'bg-gray-100 text-gray-400 group-hover:bg-blue-100 group-hover:text-blue-600']">
                      <i :class="isSelected(item.id) ? 'fa-solid fa-check' : 'fa-solid fa-plus'"></i>
                   </div>
                </div>
              </div>
            </div>
            
            <div v-if="cat === 'Granos' && showGrainWarning" class="mt-3 p-3 bg-amber-50 text-amber-700 text-xs font-semibold rounded-xl flex items-center gap-2 animate-pulse border border-amber-100">
              <i class="fa-solid fa-circle-exclamation text-amber-500 text-sm"></i>
              Recuerda: Los granos requieren seleccionar Arroz Blanco.
            </div>
          </div>

          <!-- Comments Area -->
          <div class="bg-white p-5 rounded-2xl border border-gray-100 shadow-sm mt-8">
            <label class="block text-sm font-bold text-gray-900 mb-2">Nota para la cocina <span class="text-gray-400 font-normal">(Opcional)</span></label>
            <textarea v-model="comments" rows="2" class="w-full bg-gray-50 border-gray-200 rounded-xl focus:border-blue-500 focus:ring-blue-500 focus:bg-white transition-all text-sm p-3" placeholder="Ej: Sin cebolla, por favor..."></textarea>
          </div>

        </div>
        
        <div v-if="!menuLoaded && !loading" class="py-20 text-center text-gray-400">
          <div class="w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl">
             <i class="fa-solid fa-utensils opacity-50"></i>
          </div>
          <p class="font-medium">No hay menÃº disponible para esta fecha.</p>
        </div>

        <!-- Sticky Bottom Action Bar -->
        <div v-if="!isCutoffPassed && menuLoaded" class="fixed bottom-0 left-0 right-0 p-4 bg-white/90 backdrop-blur-md border-t border-gray-200 z-50">
          <div class="max-w-4xl mx-auto flex flex-col md:flex-row gap-3 items-center">
            <div v-if="validationError" class="w-full md:w-auto flex-grow bg-red-50 text-red-600 px-4 py-3 rounded-xl text-sm font-semibold flex items-center justify-center md:justify-start gap-2 animate-shake">
               <i class="fa-solid fa-circle-xmark"></i> {{ validationError }}
            </div>
            <button @click="submitOrder" :disabled="submitting || hasBlockingErrors"
              class="w-full md:w-auto md:min-w-[300px] ml-auto bg-gray-900 hover:bg-black disabled:bg-gray-300 disabled:cursor-not-allowed text-white font-bold py-4 px-8 rounded-2xl shadow-xl shadow-gray-900/20 transition-all active:scale-95 flex justify-center items-center gap-3 text-base">
              <span v-if="submitting"><i class="fa-solid fa-circle-notch fa-spin"></i> Procesando...</span>
              <span v-else>
                 Confirmar Pedido
                 <span v-if="selectedCount > 0" class="ml-2 bg-white/20 px-2 py-0.5 rounded-md text-sm">{{ selectedCount }}</span>
              </span>
            </button>
          </div>
        </div>
      </div>
    </main>

    <!-- Footer -->
    <footer class="mt-auto py-10 bg-white border-t border-gray-100">
      <div class="max-w-4xl mx-auto px-4 relative flex flex-col items-center justify-center gap-4">
        <? if (signatureUrl) { ?>
          <img src="<?!= signatureUrl ?>" alt="Sello" class="h-10 w-auto object-contain opacity-50 grayscale hover:grayscale-0 transition-all duration-500" />
        <? } ?>
        <div class="text-center text-[10px] text-gray-400 font-bold tracking-widest uppercase">
           DirecciÃ³n de InnovaciÃ³n &copy; 2025
        </div>
      </div>
    </footer>
  </div>
  <?!= include('js'); ?>
</body>
</html>